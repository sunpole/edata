<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  
  <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="manifest" href="site.webmanifest" />
  <!-- –î–ª—è iOS/Android -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <title>–¢–∞–π–º-—Ç—Ä–µ–∫–µ—Ä | –ú–æ–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</title>
  
  <style>
:root {
  /* ------ –¶–≤–µ—Ç–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ) ------ */
  --color-accent:           #3a7afe;
  --color-accent-hover:     #236dfc;
  --color-accent-light:     #b3d1fd;
  --color-accent-xlight:    #e4eaff;
  --color-bg:               #eef3fa;
  --color-bg-white:         #fff;
  --color-bg-footer:        #f5f8fe;
  --color-bg-btn-active:    #e4eaff;
  --color-bg-dual-btn:      #cafaff;
  --color-bg-dual-btn-last: #e4eaff;
  --color-bg-calendar:      #e8f1ff;
  --color-bg-export:        #fffbe7;
  --color-input-error:      #ffe7e7;
  --color-weekend:          #ff6b6b;
  --color-weekend-bg:       #fff0f0;
  --color-close-btn:        #ff4757;
  --color-close-btn-hover:  #ff2e43;

  --color-txt:           #222;
  --color-txt-grey:      #555;
  --color-txt-accent:    #2995fa;
  --color-txt-small:     #888;
  --color-txt-export:    #993;
  --color-txt-calendar:  #217;
  --color-txt-badge:     #fff;
  --color-txt-error:     #ff4343;

  /* –û—Å—Ç–∞–ª—å–Ω–æ–µ */
  --radius-main:      18px;
  --radius-calendar:  12px;
  --radius-export:    14px;
  --radius-badge:     8px;
  --shadow:           0 3px 20px #0001;
  --footer-height:    60px;

  --container-padding-v: 1.5rem;
  --container-padding-h: 1rem;
  --container-padding-bottom: 80px;
}

/* ----- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ----- */
body.dark-theme {
  --color-accent:           #4f8dff;
  --color-accent-hover:     #266ce5;
  --color-accent-light:     #3666e680;
  --color-accent-xlight:    #262c3f;
  --color-bg:               #23252a;
  --color-bg-white:         #23252a;
  --color-bg-footer:        #242830;
  --color-bg-btn-active:    #313641;
  --color-bg-dual-btn:      #242830;
  --color-bg-dual-btn-last: #323844;
  --color-bg-calendar:      #2a2d35;
  --color-bg-export:        #191b16;
  --color-input-error:      #691818;
  --color-weekend:          #ff7f7f;
  --color-weekend-bg:       #3a2a2a;
  --color-close-btn:        #ff6b6b;
  --color-close-btn-hover:  #ff5252;
  --color-txt:           #f4f6fd;
  --color-txt-grey:      #aab2c8;
  --color-txt-accent:    #8bb8ff;
  --color-txt-small:     #8d99b4;
  --color-txt-export:    #cca;
  --color-txt-calendar:  #9ac2ff;
  --color-txt-badge:     #fff;
  --color-txt-error:     #ff4343;
}

/* === –ë–∞–∑–æ–≤–∞—è —Å–µ—Ç–∫–∞ –∏ –ø–ª–∞–≤–Ω–æ—Å—Ç—å === */
body, .container, .footer-bar, .btn, .dual-btn, .modal-inner, .export {
  transition: background .22s, color .22s, border-color .22s;
}
body {
  background: var(--color-bg);
  color: var(--color-txt);
  margin: 0;
  padding: 0;
  font-family: system-ui,sans-serif;
  min-height: 100vh;
}

.container {
  padding: var(--container-padding-v) var(--container-padding-h);
  padding-bottom: var(--container-padding-bottom);
  max-width: 420px;
  margin: auto;
  background: var(--color-bg-white);
  border-radius: var(--radius-main);
  margin-top: 3vh;
  box-shadow: var(--shadow);
}
h1 {
  margin: 0 0 12px;
  font-size: 2rem;
  font-weight: bold;
  color: var(--color-accent);
  text-align: center;
}

/* ===== FLEX GRID/COMMON ===== */
.row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}
.row-col {
  flex-direction: column;
  gap: 6px;
}
.fullw { width:100%; display:block; }
.center { text-align:center; }
hr { margin:16px 0; }

/* ========== –ö–∞—Å—Ç–æ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º ========== */
/* --- –ß–ï–ö–ë–û–ö–°–´ --- */
input[type="checkbox"] {
  appearance: none; -webkit-appearance: none;
  width:36px; height:20px; border-radius:16px;
  background: var(--color-bg-dual-btn);
  border:2px solid var(--color-accent-light);
  position: relative;
  outline: none; cursor: pointer;
  vertical-align: middle;
  transition: background .18s, border-color .22s;
  margin-right:10px; box-shadow:none;
}
input[type="checkbox"]:checked {
  background: var(--color-accent);
  border-color: var(--color-accent);
}
input[type="checkbox"]::before {
  content:''; position:absolute; left:3px; top:3px;
  width:14px; height:14px; border-radius:50%;
  background: var(--color-bg-white);
  transition: transform .18s, background .22s;
  box-shadow: 0 2px 7px #0001;
}
input[type="checkbox"]:checked::before {
  transform: translateX(16px);
  background: var(--color-bg-white);
}
input[type="checkbox"]:focus-visible {
  outline:2px solid var(--color-accent); outline-offset:2px;
}

/* --- SELECT --- */
select {
  appearance: none; -webkit-appearance: none;
  background: var(--color-bg-dual-btn);
  color: var(--color-txt);
  border:2px solid var(--color-accent-light);
  border-radius:12px;
  font-size:1em;
  padding: 0.34em 2.2em 0.34em 0.7em;
  outline: none;
  margin-right:7px; min-width:70px;
  transition: background .22s, color .22s, border-color .22s;
  box-shadow: none; cursor:pointer; position:relative;
}
select:focus-visible, select:focus { border-color:var(--color-accent); }
select[multiple] { min-height:2.4em; }
select:not([multiple]) {
  background-image: url('data:image/svg+xml;utf8,<svg height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M4 7l5 5 5-5" stroke="%23666" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
  background-repeat:no-repeat;
  background-position:right 0.7em center;
  background-size: 1.2em 1.2em;
}
body.dark-theme select:not([multiple]) {
  background-image: url('data:image/svg+xml;utf8,<svg height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M4 7l5 5 5-5" stroke="%23aabafc" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
}

/* --- NUMBER INPUT --- */
input[type="number"] {
  background: var(--color-bg-dual-btn);
  color: var(--color-txt);
  border:2px solid var(--color-accent-light);
  border-radius:10px; font-size:1em;
  padding:0.28em 0.7em; outline:none;
  margin-right:5px; box-shadow:none;
  transition: background .22s, color .22s, border-color .22s;
}
input[type="number"]:focus { border-color: var(--color-accent); }

/* --- Generic text input? (–Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ) --- */
input[type="text"], input[type="time"] {
  background: var(--color-bg-dual-btn);
  color: var(--color-txt);
  border: 2px solid var(--color-accent-light);
  border-radius: 10px;
  font-size: 1em;
  padding: .28em .7em;
  outline: none;
  transition: background .22s, color .22s, border-color .22s;
  box-shadow: none;
}
input[type="text"]:focus, input[type="time"]:focus {
  border-color: var(--color-accent);
}

/* --- Input Error --- */
input.input-error {
  border: 2px solid var(--color-txt-error) !important;
  background: var(--color-input-error) !important;
  animation: shake .4s;
}

/* ==== Dual-–∫–Ω–æ–ø–∫–∏ & –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ==== */
.dual-btn {
  display:flex; flex-direction:row; flex:1 1 0;
  border-radius:var(--radius-main); overflow:hidden;
  border:2px solid var(--color-accent);
}
.dual-btn .btn {
  border:none; border-radius:0; font-size:1.2rem;
  background:var(--color-bg-white);
  color:var(--color-accent);
  box-shadow:none; flex:1 1 0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  min-width:0; padding:0.85em 0.5em;
}
.dual-btn .btn:first-child { border-right:1px solid var(--color-accent-light); background:var(--color-bg-dual-btn);}
.dual-btn .btn:last-child  { background:var(--color-bg-dual-btn-last);}
.btn {
  background:var(--color-bg-white);
  border:2px solid var(--color-accent);
  color:var(--color-accent);
  border-radius:var(--radius-main);
  font-size:1.3rem; padding:1em 1em;
  flex: 1 1 auto; font-weight:500;
  cursor:pointer; transition:.1s;
  box-shadow:var(--shadow);
}
.btn.active, .btn:active {
  background:var(--color-bg-btn-active);
  color:var(--color-bg-white);
  border-color:var(--color-accent);
}
.btn-sub {
  font-size:.76em; color:var(--color-txt-accent);
  margin-top:2px; font-weight:400;
  letter-spacing:.02em; line-height:1;
}
/* –ö–Ω–æ–ø–∫–∞-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
.edit {
  background:none; border:none;
  color:var(--color-accent);
  font-size:1.2em; cursor:pointer; margin-left:6px;
}

/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è/–æ—Ç–º–µ–Ω—ã */
.btn-close {
  background: var(--color-close-btn);
  color: white;
  border: 2px solid var(--color-close-btn);
}
.btn-close:hover, .btn-close:active {
  background: var(--color-close-btn-hover);
  border-color: var(--color-close-btn-hover);
}

/* ===== –¢–µ–≥–∏ –∏ —Å–ø–∏—Å–∫–∏ ===== */
.tags-list { margin:.4em 0 0; padding:0; list-style:none;}
.tags-list li { padding:.2em 0; }
.badge {
  background:var(--color-accent);
  color:var(--color-txt-badge);
  border-radius:var(--radius-badge);
  padding:.1em .7em; font-size:1em;
}
.small { font-size:.92em; color:var(--color-txt-small); }

/* ==== –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ==== */
.cal-btn {
  font-size:1rem; padding:.2em 1em;
  margin:.2em; border-radius:var(--radius-calendar);
  background:var(--color-bg-calendar);
  border: none; color: var(--color-txt-calendar); cursor:pointer;
}
.cal-btn.selected { background:var(--color-accent); color:var(--color-bg-white);}
.cal-btn.weekend { 
  background: var(--color-weekend-bg); 
  color: var(--color-weekend);
}
.cal-btn.weekend.selected { 
  background: var(--color-weekend); 
  color: white;
}
.sw-btn { margin:.1em .2em; }

/* –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ */
.week-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
  margin-bottom: 10px;
  text-align: center;
  font-weight: bold;
}
.week-day {
  padding: 5px;
  font-size: 0.9em;
}
.week-day.weekend {
  color: var(--color-weekend);
}

/* ==== –ö–ù–û–ü–ö–ò –í –ü–û–î–í–ê–õ–ï ==== */
.footer-bar {
  position: fixed; left:0; right:0; bottom:0;
  background: var(--color-bg-footer);
  border-top: 1px solid var(--color-accent-light);
  display: flex; justify-content: space-around; align-items: stretch;
  z-index: 10; height: var(--footer-height);
}
.footer-btn {
  flex:1 1 0; background:var(--color-bg-white);
  border:1px solid var(--color-accent-light);
  font-size:1.20em;
  color:var(--color-accent);
  padding:7px 0 3px 0;
  cursor:pointer; outline:none;
  display:flex; flex-direction:column; align-items:center; gap:0;
  transition:background .15s;
  border-radius:8px; line-height:1.0; min-width:0;
  user-select:none; margin: 5px 3px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.footer-btn:active, .footer-btn:focus { background:var(--color-bg-btn-active);}
.footer-btn span {
  font-size:.74em; color:var(--color-txt-grey);
  margin-top:2px; font-weight:400;
}

/* ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ==== */
.modal {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: #0002; z-index:22;
  display:flex; align-items:center; justify-content:center;
}
.modal-inner {
  scroll-behavior: smooth; background:var(--color-bg-white);
  padding:1.2em; border-radius:20px;
  max-width:350px; width:95%;
  box-shadow:var(--shadow);
  max-height:90vh; overflow-y:auto;
}
.close-btn {
  float:right; background:none;
  border:none; color:#a44; font-size:1.4em; cursor:pointer;
}

/* ==== –≠–∫—Å–ø–æ—Ä—Ç, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==== */
.export {
  background:var(--color-bg-export);
  padding:.7em .8em; border-radius:var(--radius-export);
  margin-top:.6em; color:var(--color-txt-export);
  box-shadow: 0 2px 12px #d7dcaf29;
}
/* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª—å –¥–ª—è textarea –≤–Ω—É—Ç—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ */
.export textarea {
  border-radius:9px;
  outline:none;
  border:1.2px solid var(--color-accent-xlight);
  background: #fffdec;
  padding:.7em .9em;
  font-size:1em;
  width:98%;
  min-height:110px;
  margin-bottom: 8px;
  box-shadow: 0 1px 6px #b7b07130;
  color:#625440;
  resize:vertical;
}
body.dark-theme .export textarea {
  background: #24241e;
  color: #dcc;
}

/* –ö–Ω–æ–ø–æ—á–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ - –¥–µ–ª–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ, –Ω–æ —á–∏—Ç–∞–µ–º—ã–º–∏ */
.export .btn {
  margin-top:7px;
  font-size:1em;
  padding:.5em 1em;
  border-radius:10px;
}
.export .btn:first-of-type { margin-top:12px; }

/* ==== –†—è–¥ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –≤ —ç–∫—Å–ø–æ—Ä—Ç–µ ==== */
.setting-row {
  display:flex; align-items:center; gap:7px; margin:.5em 0;
}

/* ==== –°–æ—Å—Ç–æ—è–Ω–∏—è –æ—à–∏–±–æ–∫ ==== */
input.input-error {
  border:2px solid var(--color-txt-error)!important;
  background:var(--color-input-error)!important;
  animation:shake .4s;
}
/* ==== –ê–ù–ò–ú–ê–¶–ò–ò ==== */
@keyframes shake {
  0% {transform:translateX(0px);}
  20%{transform:translateX(-5px);}
  40%{transform:translateX(5px);}
  60%{transform:translateX(-4px);}
  80%{transform:translateX(4px);}
  100%{transform:translateX(0px);}
}

/* ==== –ê–¥–∞–ø—Ç–∏–≤ ==== */
@media (max-width: 400px) {
  :root { --footer-height: 48px;}
  .container { padding:.5em .3em; margin-top:1vh;}
  h1 { font-size:1.3rem;}
  .btn { font-size:1rem; padding:.6em .2em;}
  .footer-btn span { font-size: 0.70em;}
  .footer-btn { font-size: 1.02em;}
  .export textarea { font-size:.95em; }
  .footer-btn {
    padding: 5px 0 2px 0;
    margin: 3px 2px;
  }
}
@media (min-width: 401px) {
  .container { margin-top:6vh;}
}
</style>

  
</head>
<body>
<div class="container" id="app"></div>


<div class="footer-bar">
  <button class="footer-btn" onclick="showCalendar()">üìÖ<br><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
  <button class="footer-btn" onclick="showExport()">üì§<br><span>–≠–∫—Å–ø–æ—Ä—Ç</span></button>
  <button class="footer-btn" onclick="showSettings()">‚öôÔ∏è<br><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  <button class="footer-btn" onclick="showAbout()">‚ÑπÔ∏è<br><span>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span></button>
</div>

  
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤/–≤—Ä–µ–º–µ–Ω–∏/—ç–∫—Å–ø–æ—Ä—Ç/–æ—Ç—á–µ—Ç) -->
<div id="modal" style="display:none;"></div>



  
<script>
/** ================================================================
 *    TIME TRACKER ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π js-—Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 *    –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, UI –∏ –ª–æ–≥–∏–∫–∞
 * ================================================================ */

/** === CONSTANTS =============== */
const STORAGE_KEY  = "myworkdays22";
const SETTINGS_KEY = "myworkdays_settings";
const DEFAULT_TAG  = "–ù–ê–°–¢–†–û–ô–ö–ê –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø";
const APP_VERSION  = "1.0.0 (2024-06-05)"; // –¥–ª—è About

/** === LOCALSTORAGE ‚Äî INIT =============== */

// –û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π —Å —Ç—ç–≥–∞–º–∏  
let days = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
// –°–ø–∏—Å–æ–∫ —Ç—ç–≥–æ–≤  
let tagsLib = JSON.parse(localStorage.getItem("tagsLib22") || "[]");
if (!Array.isArray(tagsLib) || tagsLib.length === 0) {
  tagsLib = [DEFAULT_TAG];
} else if (!tagsLib.includes(DEFAULT_TAG)) {
  tagsLib.unshift(DEFAULT_TAG);
}
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ UI/–∑–∞—â–∏—Ç—ã  
let appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
if (typeof appSettings.copyProtect === "undefined") appSettings.copyProtect = false;
if (typeof appSettings.noZoom === "undefined") appSettings.noZoom = false;
if (typeof appSettings.theme === "undefined") appSettings.theme = "light";
if (typeof appSettings.autoTheme === "undefined") appSettings.autoTheme = true;

// =========== SETTINGS HELPERS ==================
function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
}
function saveAll() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(days));
  localStorage.setItem("tagsLib22", JSON.stringify(tagsLib));
}

/** === UI-BEHAVIOR INIT ============ */
function updateCopyProtect() {
  if (appSettings.copyProtect) {
    document.body.addEventListener('copy', blockCopy, true);
    document.body.style.userSelect = "none";
  } else {
    document.body.removeEventListener('copy', blockCopy, true);
    document.body.style.userSelect = "";
  }
}
function blockCopy(e) { e.preventDefault(); }

function updateNoZoom() {
  let viewport = document.querySelector('meta[name="viewport"]');
  if (viewport) {
    if (appSettings.noZoom) {
      viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
    } else {
      viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
    }
  }
}
function updateTheme() {
  if (appSettings.autoTheme && window.matchMedia) {
    appSettings.theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  document.body.classList.toggle("dark-theme", appSettings.theme === "dark");
}
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=> {
    if(appSettings.autoTheme) updateTheme();
  });
}

/** === BASIC HELPERS ======================= */
function findDay(date)      { return days.find(d => d.date === date); }
function todayStr()         { return (new Date()).toISOString().slice(0,10); }
function toHM(dt)           { let [h,m]=dt.split(":").map(Number); return [h||0,m||0]; }
function fromHM(h, m)       { return (h<10?'0':'')+h+":"+(m<10?'0':'')+m; }
function roundTime(timeStr, roundMin=10, direction='round') {
  let [h, m] = toHM(timeStr);
  let total = h*60+m, q = total / roundMin, res;
  if(direction==='down') res = Math.floor(q);
  else if(direction==='up') res = Math.ceil(q);
  else res = Math.round(q);
  total = res*roundMin; h = Math.floor(total/60); m = total%60;
  return fromHM(h, m);
}
function diffMinutes(tm1, tm2) {
  let [h1,m1]=toHM(tm1), [h2,m2]=toHM(tm2);
  return (h2*60+m2)-(h1*60+m1);
}

// == INIT UI SETTINGS ==
updateCopyProtect();
updateNoZoom();
updateTheme();



function roundMinutes(totalMin, step=10, direction='round') {
  let q = totalMin / step, res;
  if(direction==='down') res = Math.floor(q);
  else if(direction==='up') res = Math.ceil(q);
  else res = Math.round(q);
  return res * step;
}

/* === –≠–ö–°–ü–û–†–¢ –û–¢–ß–Å–¢–ê === */
function showExport() {
  let minDate = days.length ? days[0].date : todayStr();
  let maxDate = days.length ? days[days.length-1].date : todayStr();
  let html = `
    <div><b>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</b></div>
    <form id="reportForm">
      <div class="setting-row">–ü–µ—Ä–∏–æ–¥: 
        <select id="per">
          <option value="1-15">1‚Äì15</option>
          <option value="16-31">16‚Äì31</option>
          <option value="full">–í–µ—Å—å –º–µ—Å—è—Ü</option>
          <option value="range">–ü–µ—Ä–∏–æ–¥</option>
        </select>
        <input type="date" id="dfrom" style="display:none" value="${minDate}"> -
        <input type="date" id="dto" style="display:none" value="${maxDate}">
      </div>
      <div class="setting-row">–≠–∫—Å–ø–æ—Ä—Ç:
        <select id="expType">
          <option value="all">–í—Å—ë</option>
          <option value="tags">–¢–æ–ª—å–∫–æ —Ç–µ–≥–∏</option>
          <option value="work">–¢–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã (–ø—Ä–∏—Ö–æ–¥/—É—Ö–æ–¥)</option>
        </select>
      </div>
      <div class="setting-row">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ:
        <select id="roundM">
          <option value="60">–î–æ 1 —á–∞—Å–∞</option>
          <option value="30">–î–æ 30 –º–∏–Ω</option>
          <option value="10" selected>–î–æ 10 –º–∏–Ω</option>
        </select>
        <select id="roundDir">
          <option value="round">–û–±—ã—á–Ω–æ</option>
          <option value="up">–í–≤–µ—Ä—Ö</option>
          <option value="down">–í–Ω–∏–∑</option>
        </select>
      </div>
      <div class="setting-row">–¢–µ–≥–∏: <select multiple id="tagsFlt" style="min-width:70px;min-height:2em;">
        ${tagsLib.map(t=>`<option value="${t}" selected>${t}</option>`).join("")}
      </select> <span class="small">(–¥–ª—è —Ä–µ–∂–∏–º–∞ "—Ç–µ–≥–∏")</span></div>
      <button class="btn fullw" type="submit">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn btn-close fullw" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
    <div id="exportResult"></div>
  `;
  showModal(html);

  let perSel = document.getElementById("per");
  let fromD = document.getElementById("dfrom");
  let toD = document.getElementById("dto");
  perSel.onchange = function() {
    if(perSel.value==='range'){
      fromD.style.display='inline';
      toD.style.display='inline';
    } else {
      fromD.style.display='none';
      toD.style.display='none';
    }
  };

  document.getElementById("reportForm").onsubmit = function(e) {
    e.preventDefault();
    let period = perSel.value;
    let from = fromD.value || minDate;
    let to = toD.value || maxDate;
    let exp = document.getElementById("expType").value;
    let roundM = +document.getElementById("roundM").value;
    let roundDir = document.getElementById("roundDir").value;
    let tagsFlt = Array.from(document.getElementById("tagsFlt").selectedOptions).map(op=>op.value);

    let list;
    if (period === "1-15") {
      list = days.filter(d=>+d.date.slice(8,10)<=15 && inThisMonth(d.date));
    } else if(period === "16-31") {
      list = days.filter(d=>+d.date.slice(8,10)>=16 && inThisMonth(d.date));
    } else if(period === "range") {
      list = days.filter(d=>d.date >= from && d.date <= to);
    } else { // full
      list = days.filter(d=>inThisMonth(d.date));
    }
    function inThisMonth(dt) {
      let selm = days.length ? days[days.length-1].date.slice(5,7) : todayStr().slice(5,7);
      return dt.slice(5,7) === selm;
    }

    let rows = [];
    let tagTotals = {};

    // ===== –û–¢–ß–Å–¢ –ü–û –†–ê–ë–û–ß–ï–ú–£ –í–†–ï–ú–ï–ù–ò =====
    if (exp === 'work' || exp === 'all') {
      for (const d of list) {
        if (!d.start || !d.end) continue;
        let mins = diffMinutes(d.start, d.end);
        let rounded = roundMinutes(mins, roundM, roundDir);
        let hr = Math.floor(rounded / 60), mn = rounded % 60;
        rows.push(`${d.date}: ${d.start} ‚Äì ${d.end} (${hr}—á ${mn}–º)`);
      }
    }

    // ===== –û–¢–ß–Å–¢ –ü–û –¢–ï–ì–ê–ú =====
    if (exp === 'tags' || exp === 'all') {
      for (const d of list) {
        if (!d.tags?.length) continue;
        for (const tag of d.tags) {
          if (tagsFlt.includes(tag.tag)) {
            let mins = diffMinutes(tag.start, tag.end);
            if (!tagTotals[tag.tag]) tagTotals[tag.tag] = 0;
            tagTotals[tag.tag] += mins > 0 ? mins : 0;
            let rounded = roundMinutes(mins, roundM, roundDir);
            let hr = Math.floor(rounded / 60), mn = rounded % 60;
            rows.push(`${d.date}: ${tag.tag} ‚Äî ${tag.start}-${tag.end} (${hr}—á ${mn}–º)`);
          }
        }
      }
      if (Object.keys(tagTotals).length) {
        rows.push('\n–°—É–º–º–∞—Ä–Ω–æ –ø–æ —Ç–µ–≥–∞–º:');
        for (const tag of Object.keys(tagTotals)) {
          let tot = tagTotals[tag];
          let rounded = roundMinutes(tot, roundM, roundDir);
          let hr = Math.floor(rounded / 60), mn = rounded % 60;
          rows.push(`${tag}: ${hr}—á ${mn}–º`);
        }
      }
    }

    let resTxt = rows.join('\n');
    document.getElementById("exportResult").innerHTML =
      `<div class="export"><b>–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç:</b><br>
      <textarea style="width:98%;min-height:120px">${resTxt}</textarea>
      <br>
      <button class="btn" type="button" onclick="downloadText()">–°–∫–∞—á–∞—Ç—å .txt</button>
      <button class="btn" type="button" onclick="copyExportText()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn" type="button" onclick="shareToTelegram()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
      </div>`;
    window.export__text = resTxt;
    return false;
  };
}

// --- –û–¢–ü–†–ê–í–ò–¢–¨ –í TELEGRAM ---
function shareToTelegram() {
  if (!window.export__text) return;
  let text = window.export__text;
  if (text.length > 4000) text = text.slice(0, 4000) + '...';
  let url = "https://t.me/share/url?url=&text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

// --- –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –í –ë–£–§–ï–† ---
function copyExportText() {
  if (!window.export__text) return;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(window.export__text)
      .then(() => { alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"); })
      .catch(() => { fallbackCopy(); });
  } else {
    fallbackCopy();
  }
  function fallbackCopy() {
    try {
      let ta = document.createElement("textarea");
      ta.value = window.export__text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    } catch {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
    }
  }
}

// --- –°–ö–ê–ß–ê–¢–¨ TXT ---
function downloadText() {
  let b = new Blob([window.export__text || ""], { type:"text/plain" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(b);
  link.download = "work_report.txt";
  link.click();
}
  

  

/** =========================================================  
 *               MAIN RENDER FUNCTION (–≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)  
 * ========================================================= */  
function renderApp() {  
  let dt = todayStr();  
  let day = findDay(dt);  
  let rows = [];  
  rows.push(`<h1>–ú–æ–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</h1>`);  
  rows.push(`  
    <div class="row">  
      <div class="dual-btn">  
        <button class="btn" onclick="markNow('start')">‚ûî ${day?.start || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø</div></button>  
        <button class="btn" onclick="openManualTime('start')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨ –í–†–ï–ú–Ø</div></button>  
      </div>  
      <div class="dual-btn">  
        <button class="btn" onclick="markNow('end')">‚è± ${day?.end || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø</div></button>  
        <button class="btn" onclick="openManualTime('end')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨ –í–†–ï–ú–Ø</div></button>  
      </div>  
    </div>  
  `);  
  // –ò—Ç–æ–≥ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è  
  if(day?.start && day?.end) {  
    let time = diffMinutes(day.start, day.end);  
    rows.push(`<div class="center"><span class="badge">${Math.floor(time/60)}—á ${(time%60).toString().padStart(2,"0")}–º</span> –æ–±—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</div>`);  
  }  

  // ======= –°–ø–∏—Å–æ–∫ —Ç—ç–≥–æ–≤ –∏ –∏—Ç–æ–≥–∏ –ø–æ —Ç–µ–≥–∞–º ========  
  rows.push(`<hr><div><b>–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b></div>`);  
  let tagSums = {};  
  if (day?.tags?.length) {  
    rows.push('<ul class="tags-list">');  
    day.tags.forEach((t, i) => {  
      let st = t.start, en = t.end;  
      let mins = (st && en) ? diffMinutes(st, en) : 0;  
      if (!tagSums[t.tag]) tagSums[t.tag] = 0;  
      tagSums[t.tag] += mins > 0 ? mins : 0;  
      let hr = Math.floor(mins/60), mn = mins%60;  
      rows.push(  
      `<li>  
        <b>${t.tag}</b> ${st || '--:--'}‚Ä¶${en || '--:--'}${mins>0 ? ` <span class="small">(${hr}—á ${mn}–º)</span>` : ''}  
        <div class="row" style="margin:.3em 0;flex-wrap:wrap;">  
          <div class="dual-btn">  
            <button class="btn" onclick="markTagNow(${i}, 'start')">‚ûî ${t.start || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>  
            <button class="btn" onclick="manualTagTime(${i}, 'start')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>  
          </div>  
          <div class="dual-btn">  
            <button class="btn" onclick="markTagNow(${i}, 'end')">‚è± ${t.end || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>  
            <button class="btn" onclick="manualTagTime(${i}, 'end')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>  
          </div>  
          <button class="edit" onclick="editTag(${i})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥">‚úé</button>  
          <button class="edit" onclick="delTag(${i})" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥">‚úï</button>  
        </div>  
      </li>`);  
    });  
    // + –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ–≥  
    rows.push(`  
      <li>  
        <button class="btn fullw" onclick="addTagPlus()" style="display:flex;align-items:center;gap:7px;justify-content:center;margin-top:4px;">  
          ‚ûï<span style="color:#888;font-size:.96em;">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</span>  
        </button>  
      </li>  
    `);  
    rows.push('</ul>');  
    // –ò—Ç–æ–≥–∏ –ø–æ —Ç–µ–≥–∞–º –∑–∞ —Å–µ–≥–æ–¥–Ω—è  
    if (Object.keys(tagSums).length > 0) {  
      rows.push(`<div class="small" style="margin:7px 0 0 2px;"><b>–ò—Ç–æ–≥–æ –ø–æ —Ç–µ–≥–∞–º –∑–∞ —Å–µ–≥–æ–¥–Ω—è:</b><br>`);  
      for (const tag in tagSums) {  
        let tot = tagSums[tag], hr = Math.floor(tot/60), mn = tot%60;  
        rows.push(`${tag}: ${hr}—á ${mn}–º<br>`);  
      }  
      rows.push(`</div>`);  
    }  
  } else {  
    rows.push(`<div class="small">–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>  
      <button class="btn fullw" onclick="addTagPlus()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>`);  
  }  
  rows.push(`<hr>`);  
  // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–Ω–¥–µ—Ä  
  document.getElementById('app').innerHTML = rows.join('\n');  
  closeModal();  
}  
window.renderApp = renderApp;  

/** === MARK HANDLERS ==== */  
function markNow(type) {  
  let dt = todayStr(), now = new Date(), h = now.getHours(), m = now.getMinutes();  
  let tstr = fromHM(h, m); let day = findDay(dt);  
  if(!day) { day = {date: dt, start: '', end: '', tags:[]}; days.push(day);}  
  day[type] = tstr; saveAll(); renderApp();  
}  
function openManualTime(type) {  
  let dt = todayStr(), day = findDay(dt) || { date: dt, start: '', end: '', tags: [] };  
  let val = (day[type] && /^\d\d:\d\d$/.test(day[type]))  
    ? day[type]  
    : (() => {let d = new Date(), h = d.getHours(), m = d.getMinutes(); return (h<10?'0':'')+h+":"+(m<10?'0':'')+m;})();  
  let label = type === "start" ? "–í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞" : "–í—Ä–µ–º—è —É—Ö–æ–¥–∞";  
  let html = `  
    <form id="manualTimeForm">  
      <label>${label}:<br>  
        <input type="time" id="manualTimeInput" value="${val}" required>  
      </label>  
      <div class="row" style="margin-top:16px;">  
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>  
        <button type="button" class="btn btn-close fullw" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>  
      </div>  
    </form>  
  `;  
  showModal(html);  
  document.getElementById('manualTimeForm').onsubmit = function(e) {  
    e.preventDefault();  
    const input = document.getElementById('manualTimeInput');  
    const t = input.value.trim();  
    if (!t) {  
      input.classList.add('input-error');  
      input.focus();  
      setTimeout(() => input.classList.remove('input-error'), 1000);  
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!');  
      return;  
    }  
    let curday = findDay(dt);  
    if(!curday) { curday = { date: dt, start: '', end: '', tags: [] }; days.push(curday); }  
    curday[type] = t;  
    saveAll();  
    renderApp();  
  };  
}   

function markTagNow(idx, type) {  
  let dt = todayStr();  
  let day = findDay(dt);  
  if (!day || !day.tags[idx]) return;  
  let now = new Date();  
  let h = now.getHours(), m = now.getMinutes();  
  let tstr = fromHM(h, m);  
  day.tags[idx][type] = tstr;  
  saveAll();  
  renderApp();  
}  
function manualTagTime(idx, type) {  
  let dt = todayStr();  
  let day = findDay(dt);  
  let t = (day && day.tags[idx] && day.tags[idx][type]) || "";  
  let label = (type === "start" ? "–ù–∞—á–∞–ª–æ —Ç–µ–≥–∞" : "–ö–æ–Ω–µ—Ü —Ç–µ–≥–∞");  
  let html = `  
    <form id="manualTagTimeForm">  
      <label>${label}:<br>  
        <input type="time" id="manualTagTimeInput" value="${t}" required>  
      </label>  
      <div class="row" style="margin-top:16px;">  
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>  
        <button type="button" class="btn btn-close fullw" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>  
      </div>  
    </form>  
  `;  
  showModal(html);  
  document.getElementById('manualTagTimeForm').onsubmit = function(e) {  
    e.preventDefault();  
    const input = document.getElementById('manualTagTimeInput');  
    const val = input.value.trim();  
    if (!val) {  
      input.classList.add('input-error');  
      input.focus();  
      setTimeout(() => input.classList.remove('input-error'), 1000);  
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!');  
      return;  
    }  
    day.tags[idx][type] = val;  
    saveAll();  
    renderApp();  
  };  
}  
// === –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞ ===  
function addTagPlus() {  
  let dt = todayStr();  
  let day = findDay(dt);  
  if (!day) return;  
  let now = new Date();  
  let tstr = fromHM(now.getHours(), now.getMinutes());  
  day.tags.push({ tag: DEFAULT_TAG, start: "", end: "" });  
  saveAll();  
  renderApp();  
}  
function editTags() {  
  let dt = todayStr(); let day = findDay(dt);  
  if(!day) {alert("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—Ç—å—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞ (–∏ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —É—Ö–æ–¥–∞)!");return;}  
  showTagModal(null, dt);  
}  
function editTag(idx) {  
  let dt = todayStr(); let day = findDay(dt);  
  showTagModal(idx, dt);  
}  
function delTag(idx) {  
  let dt = todayStr(); let day = findDay(dt);  
  if(day && day.tags && day.tags[idx] !== undefined) {  
    if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "+day.tags[idx].tag+"?")) {  
      day.tags.splice(idx,1);  
      saveAll();  
      renderApp();  
    }  
  }  
}  

// === Tag Modal (edit/new) ===  
function showTagModal(tagIdx, forDate) {  
  let day = findDay(forDate);   
  if (!day) return;  
  let tagObj;  
  if (tagIdx !== null && day.tags[tagIdx]) {  
    tagObj = { ...day.tags[tagIdx] };  
  } else {  
    tagObj = { tag: DEFAULT_TAG, start: day.start || "09:00", end: day.end || "18:00" };  
  }  
  let tagOptions = [DEFAULT_TAG, ...tagsLib.filter(t => t !== DEFAULT_TAG)]  
    .map(t => `<option value="${t}"></option>`).join("");  
  let html = `  
    <form id="tagForm">  
      <label>–¢–µ–≥:<br>  
        <input type="text" list="tagsSug" value="${tagObj.tag || ''}" id="tg" required autocomplete="off">  
        <datalist id="tagsSug">${tagOptions}</datalist>  
      </label><br>  
      <label>–ù–∞—á–∞–ª–æ:<br>  
        <input type="time" id="st" value="${tagObj.start}" required>  
      </label><br>  
      <label>–ö–æ–Ω–µ—Ü:<br>  
        <input type="time" id="en" value="${tagObj.end}" required>  
      </label><br>  
      <div class="row">  
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>  
        <button type="button" class="btn btn-close fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>  
      </div>  
    </form>  
  `;  
  showModal(html);  
  document.getElementById('tagForm').onsubmit = function(e) {  
    e.preventDefault();  
    let tg = document.getElementById('tg').value.trim();  
    let st = document.getElementById('st').value, en = document.getElementById('en').value;  
    if (!tg) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥");  
    if (!tagsLib.includes(tg)) tagsLib.push(tg);  
    if (tagIdx !== null) day.tags[tagIdx] = { tag: tg, start: st, end: en };  
    else day.tags.push({ tag: tg, start: st, end: en });  
    saveAll(); renderApp();  
  };  
}  

/** === CALENDAR UI === */  
function showCalendar(mon=null, yr=null) {  
  let now = new Date();  
  let year = yr || now.getFullYear();  
  let month = mon!==null ? mon : now.getMonth(); // 0-based  
  let first = new Date(year,month,1);  
  let last = new Date(year,month+1,0);  
  let daysNum = last.getDate();  
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ —Ç.–¥.)
  let firstDayOfWeek = first.getDay();
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (0) –≤ 7 –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞—Å—á–µ—Ç–æ–≤
  if (firstDayOfWeek === 0) firstDayOfWeek = 7;
  
  let content = `
    <div style='text-align:center; margin-bottom: 15px;'>
      <b>${["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"][month]} ${year}</b>
    </div>
    
    <div class="week-days">
      <div class="week-day">–ü–Ω</div>
      <div class="week-day">–í—Ç</div>
      <div class="week-day">–°—Ä</div>
      <div class="week-day">–ß—Ç</div>
      <div class="week-day">–ü—Ç</div>
      <div class="week-day weekend">–°–±</div>
      <div class="week-day weekend">–í—Å</div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
  `;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –¥–æ –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞
  for (let i = 1; i < firstDayOfWeek; i++) {
    content += `<div style="height: 35px;"></div>`;
  }
  
  for(let i=1; i<=daysNum; i++) {
    let ds = `${year}-${(month+1).toString().padStart(2,"0")}-${i.toString().padStart(2,"0")}`;
    let hasData = days.some(d=>d.date===ds);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 6 - —Å—É–±–±–æ—Ç–∞)
    let dayOfWeek = new Date(year, month, i).getDay();
    let isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    
    content += `
      <button class="cal-btn${hasData?' selected':''}${isWeekend?' weekend':''}" 
              onclick="showDay('${ds}')" 
              style="width: 100%; height: 35px; padding: 5px;">
        ${i}
      </button>
    `;
  }
  
  content += `</div>
    <div class='center' style="margin-top: 15px;">
      <button class="sw-btn" onclick="showCalendar(${month-1<0?11:month-1},${month-1<0?year-1:year})">‚Üê</button>
      <button class="sw-btn" onclick="showCalendar(${month+1>11?0:month+1},${month+1>11?year+1:year})">‚Üí</button>
    </div>
    <div class='center' style="margin-top: 15px;">
      <button class="btn btn-close" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>`;
    
  showModal(content);
}

function showDay(ds) {
  let day = findDay(ds) || { date: ds, start: '', end: '', tags: [] };
  let html = `
    <b>${formatDate(ds)}</b><br>
    <div style="margin: 10px 0;">
      <label>–í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞:
        <input type="time" id="editStart" value="${day.start || ''}" style="margin-left: 5px;">
      </label><br>
      <label>–í—Ä–µ–º—è —É—Ö–æ–¥–∞:
        <input type="time" id="editEnd" value="${day.end || ''}" style="margin-left: 5px;">
      </label>
    </div>`;

  if (day.tags?.length) {
    html += `<div><b>–¢–µ–≥–∏:</b></div><ul class="tags-list">`;
    let tagSums = {};
    day.tags.forEach((t, index) => {
      let st = t.start, en = t.end;
      let mins = (st && en) ? diffMinutes(st, en) : 0;
      if (!tagSums[t.tag]) tagSums[t.tag] = 0;
      tagSums[t.tag] += mins > 0 ? mins : 0;
      let hr = Math.floor(mins/60), mn = mins%60;
      
      html += `
        <li>
          <b>${t.tag}</b> 
          <input type="time" value="${st || ''}" id="tagStart${index}" style="width: 80px; margin: 0 5px;">
          -
          <input type="time" value="${en || ''}" id="tagEnd${index}" style="width: 80px; margin: 0 5px;">
          ${(mins > 0 ? `(${hr}—á ${mn}–º)` : '')}
          <button class="edit" onclick="removeTagFromDay('${ds}', ${index})" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥">‚úï</button>
        </li>`;
    });
    html += `</ul>`;
    
    // –°—É–º–º–∞—Ä–Ω–æ –ø–æ —Ç–µ–≥–∞–º –∑–∞ –¥–µ–Ω—å
    if(Object.keys(tagSums).length){
      html += `<div class="small" style="margin-top:8px;"><b>–ò—Ç–æ–≥–æ –ø–æ —Ç–µ–≥–∞–º –∑–∞ –¥–µ–Ω—å:</b><br>`;
      for(const tag in tagSums){
        let tot = tagSums[tag], hr=Math.floor(tot/60), mn=tot%60;
        html += `${tag}: ${hr}—á ${mn}–º<br>`;
      }
      html += `</div>`;
    }
  } else {
    html += `<div class="small">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>`;
  }
  
  html += `
    <div style="margin: 15px 0;">
      <button class="btn" onclick="addNewTagToDay('${ds}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
    </div>
    
    <div class='row'>
      <button class="btn fullw" onclick="saveDayChanges('${ds}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      <button class="btn btn-close fullw" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  
  showModal(html);
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  return date.toLocaleDateString('ru-RU', options);
}

function saveDayChanges(dateStr) {
  let day = findDay(dateStr);
  if (!day) {
    day = { date: dateStr, start: '', end: '', tags: [] };
    days.push(day);
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞/—É—Ö–æ–¥–∞
  day.start = document.getElementById('editStart').value;
  day.end = document.getElementById('editEnd').value;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–≥–∏
  if (day.tags) {
    for (let i = 0; i < day.tags.length; i++) {
      day.tags[i].start = document.getElementById(`tagStart${i}`).value;
      day.tags[i].end = document.getElementById(`tagEnd${i}`).value;
    }
  }
  
  saveAll();
  showDay(dateStr); // –û–±–Ω–æ–≤–ª—è–µ–º view
}

function addNewTagToDay(dateStr) {
  let day = findDay(dateStr);
  if (!day) {
    day = { date: dateStr, start: '', end: '', tags: [] };
    days.push(day);
  }
  
  if (!day.tags) day.tags = [];
  day.tags.push({ tag: DEFAULT_TAG, start: "09:00", end: "18:00" });
  
  saveAll();
  showDay(dateStr); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º view
}

function removeTagFromDay(dateStr, index) {
  let day = findDay(dateStr);
  if (day && day.tags && day.tags[index]) {
    day.tags.splice(index, 1);
    saveAll();
    showDay(dateStr);
  }
}

/** === EXPORT, SETTINGS, ABOUT –∏ –ü—Ä–æ—á–µ–µ UI === */

// --- –≠–∫—Å–ø–æ—Ä—Ç ---
function downloadText() {
  let b = new Blob([window.export__text || ""], { type:"text/plain" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(b);
  link.download = "work_report.txt";
  link.click();
}

// ...–§—É–Ω–∫—Ü–∏—è showExport —É–∂–µ –¥–∞–Ω–∞ —Ä–∞–Ω–µ–µ, –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ä—è–¥–æ–º...

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
function showSettings() {
  let html = `
    <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>
    <ul class="tags-list">
      <li>
        <label>
          <input type="checkbox" id="setCopyProtect" ${appSettings.copyProtect ? "checked" : ""}>
          üõ°Ô∏è –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        </label>
      </li>
      <li>
        <label>
          <input type="checkbox" id="setNoZoom" ${appSettings.noZoom ? "checked" : ""}>
          üîí –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        </label>
      </li>
      <li>
        <label>
          <input type="checkbox" id="setAutoTheme" ${appSettings.autoTheme ? "checked" : ""}>
          üåì –ü–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–º—É —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        </label>
      </li>
      <li>
        <label>
          üé® –¢–µ–º–Ω–∞—è —Ç–µ–º–∞:
          <select id="setTheme" ${appSettings.autoTheme ? "disabled" : ""}>
            <option value="light" ${appSettings.theme === "light" ? "selected" : ""}>–°–≤–µ—Ç–ª–∞—è</option>
            <option value="dark" ${appSettings.theme === "dark" ? "selected" : ""}>–¢–µ–º–Ω–∞—è</option>
          </select>
        </label>
      </li>
      <li><hr></li>
      <li><b>–ú–æ–∏ —Ç–µ–≥–∏:</b></li>
      ${tagsLib.map((t, i) => `
        <li style="margin-bottom:6px;">
          <span class="badge">${t}</span>
          ${i === 0
            ? '<span class="small">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)</span>'
            : `<button class="edit" onclick="removeTagLib(${i})">‚úï —É–¥–∞–ª–∏—Ç—å</button>`}
        </li>
      `).join("")}
      <li>
        <input type="text" id="newTgInp" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥...">
        <button class="btn" onclick="addTagFromSettings()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </li>
      <li>
        <button class="btn" onclick="resetAllData()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <span class="small">(–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ)</span>
      </li>
    </ul>
    <button class="btn btn-close fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  `;
  showModal(html);

  // --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π ---
  document.getElementById('setCopyProtect').onchange = function() {
    appSettings.copyProtect = this.checked; saveSettings(); updateCopyProtect();
  };
  document.getElementById('setNoZoom').onchange = function() {
    appSettings.noZoom = this.checked; saveSettings(); updateNoZoom();
  };
  document.getElementById('setAutoTheme').onchange = function() {
    appSettings.autoTheme = this.checked; saveSettings();
    document.getElementById('setTheme').disabled = appSettings.autoTheme;
    updateTheme();
  };
  document.getElementById('setTheme').onchange = function() {
    appSettings.theme = this.value; saveSettings(); updateTheme();
  };
}
function addTagFromSettings() {
  let inp = document.getElementById('newTgInp');
  let newTag = inp.value.trim();
  if(!newTag) return;
  if(!tagsLib.includes(newTag)) {
    tagsLib.push(newTag);
    saveAll();
    closeModal();
    renderApp();
  }
}
function removeTagLib(i) {
  if (i === 0) return; // –Ω–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–≥
  if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${tagsLib[i]}"? –í—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º —Ç–µ–≥–æ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è, –Ω–æ –Ω–æ–≤—ã–π –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.`)) {
    tagsLib.splice(i, 1);
    saveAll();
    showSettings();
    renderApp();
  }
}
function resetAllData() {
  if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
    days = [];
    tagsLib = [DEFAULT_TAG];
    saveAll();
    closeModal();
    renderApp();
  }
}

// --- About ---
function showAbout() {
  let html = `
    <b>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</b><br>
    <div class="small" style="line-height:1.7;">
      <b>–ê–≤—Ç–æ—Ä –∏–¥–µ–∏:</b> –ê–Ω—Ç–æ–Ω –ú–∞–≥–æ–º–µ–¥–æ–≤<br>
      <b>Telegram / Instagram:</b> <a href="https://t.me/xcve33" target="_blank">@xcve33</a><br>
      <b>Email:</b> <a href="mailto:akitsatnafiya@gmail.com">akitsatnafiya@gmail.com</a><br>
      <b>GitHub:</b> <a href="https://github.com/sunpole" target="_blank">sunpole</a><br>
      <br>
      <b>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞:</b><br>
      –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ ‚Äî —á–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ <a href="https://www.sider.ai/" target="_blank">sider.ai</a>, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ—Ä–∏–∏ –ø—Ä–æ–º—Ç–æ–≤ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –æ—Ç –∞–≤—Ç–æ—Ä–∞.<br>
      –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —á–µ—Å—Ç–Ω–æ –∏ —Ä–∞–¥–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —Å AI.<br>
      <br>
      <b>–í–µ—Ä—Å–∏—è:</b> ${APP_VERSION}<br>
      <b>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</b><br>
      –¢—Ä–µ–∫–µ—Ä —É—á—ë—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞, —É—Ö–æ–¥–∞ –∏ –≤–∏–¥–æ–≤ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ —Ç–µ–≥–∞–º.<br>
      <br>
      <b>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</b><br>
      ‚Äî –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (LocalStorage –±—Ä–∞—É–∑–µ—Ä–∞)<br>
      ‚Äî –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞<br>
      ‚Äî –ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç—ã –≤ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏<br>
      <br>
      <b>–í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞.</b><br>
      –õ—é–±–∞—è –≤–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –æ—Ç–∑—ã–≤ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—á–µ–Ω—å —Ü–µ–Ω–Ω—ã –¥–ª—è –º–µ–Ω—è.<br>
      <br>
      <button class="btn btn-close" style="font-size:0.98em;white-space:normal;line-height:1.1;padding:0.7em 1em;" onclick="closeModal()">–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ</button>
    </div>
  `;
  showModal(html);
}

  
/** === MODAL CORE === */
function showModal(html) {
  let m = document.getElementById("modal");
  m.innerHTML = `<div class="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">${html}</div>
  </div>`;
  m.style.display = '';
}
function closeModal(e) {
  if(e && e.target!==document.getElementById("modal"))return;
  document.getElementById("modal").style.display='none';
}

// == –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==
renderApp();
</script>

  
</body>
</html>
