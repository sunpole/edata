<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  
  <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π favicon -->
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="manifest" href="site.webmanifest" />
  <!-- –î–ª—è iOS/Android -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <title>–¢–∞–π–º-—Ç—Ä–µ–∫–µ—Ä | –ú–æ–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</title>
  <style>
    :root {
  /* –¶–≤–µ—Ç–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
  --color-accent: #3a7afe;
  --color-accent-light: #b3d1fd;
  --color-bg: #eef3fa;
  --color-bg-white: #fff;
  --color-bg-footer: #f5f8fe;
  --color-bg-btn-active: #e4eaff;
  --color-bg-dual-btn: #cafaff;
  --color-bg-dual-btn-last: #e4eaff;
  --color-bg-calendar: #e8f1ff;
  --color-bg-export: #fffbe7;
  --color-input-error: #ffe7e7;

  --color-txt: #222;
  --color-txt-grey: #555;
  --color-txt-accent: #2995fa;
  --color-txt-small: #888;
  --color-txt-export: #993;
  --color-txt-calendar: #217;
  --color-txt-badge: #fff;
  --color-txt-error: #ff4343;

  --radius-main: 18px;
  --radius-calendar: 12px;
  --radius-export: 14px;
  --radius-badge: 8px;
  --shadow: 0 3px 20px #0001;

  --footer-height: 60px;

  /* –û—Ç—Å—Ç—É–ø—ã */
  --container-padding-v: 1.5rem;
  --container-padding-h: 1rem;
  --container-padding-bottom: 80px;
}

/* ===== –ë–ê–ó–û–í–ê–Ø –°–ï–¢–ö–ê ===== */
body {
  background: var(--color-bg);
  color: var(--color-txt);
  margin: 0;
  padding: 0;
  font-family: system-ui, sans-serif;
  min-height: 100vh;
}

.container {
  padding: var(--container-padding-v) var(--container-padding-h);
  padding-bottom: var(--container-padding-bottom);
  max-width: 420px;
  margin: auto;
  background: var(--color-bg-white);
  border-radius: var(--radius-main);
  margin-top: 3vh;
  box-shadow: var(--shadow);
}

h1 {
  margin: 0 0 12px;
  font-size: 2rem;
  font-weight: bold;
  color: var(--color-accent);
  text-align: center;
}

.row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

.row-col {
  flex-direction: column;
  gap: 6px;
}

.fullw {
  width: 100%;
  display: block;
}

.center {
  text-align: center;
}

hr {
  margin: 16px 0;
}

/* ====== –î–í–û–ô–ù–´–ï –ö–ù–û–ü–ö–ò ====== */
.dual-btn {
  display: flex;
  flex-direction: row;
  flex: 1 1 0;
  border-radius: var(--radius-main);
  overflow: hidden;
  border: 2px solid var(--color-accent);
}

.dual-btn .btn {
  border: none;
  border-radius: 0;
  font-size: 1.2rem;
  background: var(--color-bg-white);
  color: var(--color-accent);
  box-shadow: none;
  flex: 1 1 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 0;
  padding: 0.85em 0.5em;
}

.dual-btn .btn:first-child {
  border-right: 1px solid var(--color-accent-light);
  background: var(--color-bg-dual-btn);
}
.dual-btn .btn:last-child {
  background: var(--color-bg-dual-btn-last);
}

/* –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
.btn {
  background: var(--color-bg-white);
  border: 2px solid var(--color-accent);
  color: var(--color-accent);
  border-radius: var(--radius-main);
  font-size: 1.3rem;
  padding: 1em 1em;
  flex: 1 1 auto;
  font-weight: 500;
  cursor: pointer;
  transition: 0.1s;
  box-shadow: var(--shadow);
}

.btn.active,
.btn:active {
  background: var(--color-bg-btn-active);
  color: var(--color-bg-white);
  border-color: var(--color-accent);
}

/* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö */
.btn-sub {
  font-size: 0.76em;
  color: var(--color-txt-accent);
  margin-top: 2px;
  font-weight: 400;
  letter-spacing: 0.02em;
  line-height: 1;
}

/* –ö–Ω–æ–ø–∫–∞-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
.edit {
  background: none;
  border: none;
  color: var(--color-accent);
  font-size: 1.2em;
  cursor: pointer;
  margin-left: 6px;
}

/* ==== –¢–µ–≥–∏ –∏ —Å–ø–∏—Å–∫–∏ ==== */
.tags-list {
  margin: .4em 0 0;
  padding: 0;
  list-style: none;
}
.tags-list li {
  padding: .2em 0;
}

.badge {
  background: var(--color-accent);
  color: var(--color-txt-badge);
  border-radius: var(--radius-badge);
  padding: .1em .7em;
  font-size: 1em;
}

.small {
  font-size: .92em;
  color: var(--color-txt-small);
}

/* ==== –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ==== */
.cal-btn {
  font-size: 1rem;
  padding: .2em 1em;
  margin: .2em;
  border-radius: var(--radius-calendar);
  background: var(--color-bg-calendar);
  border: none;
  color: var(--color-txt-calendar);
  cursor: pointer;
}
.cal-btn.selected {
  background: var(--color-accent);
  color: var(--color-bg-white);
}

/* ==== –ö–ù–û–ü–ö–ò –í –ü–û–î–í–ê–õ–ï ==== */
.footer-bar {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--color-bg-footer);
  border-top: 1px solid var(--color-accent-light);
  display: flex;
  justify-content: space-around;
  align-items: stretch;
  z-index: 10;
  height: var(--footer-height);
}

.footer-btn {
  flex: 1 1 0;
  background: none;
  border: none;
  font-size: 1.20em;
  color: var(--color-accent);
  padding: 7px 0 3px 0;
  cursor: pointer;
  outline: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  transition: background 0.15s;
  border-radius: 0;
  line-height: 1.0;
  min-width: 0;
  user-select: none;
}
.footer-btn:active,
.footer-btn:focus {
  background: var(--color-bg-btn-active);
}
.footer-btn span {
  font-size: 0.74em;
  color: var(--color-txt-grey);
  margin-top: 2px;
  font-weight: 400;
}

/* ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ==== */
.modal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #0002;
  z-index: 22;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-inner {
  scroll-behavior: smooth;
  background: var(--color-bg-white);
  padding: 1.2em;
  border-radius: 20px;
  max-width: 350px;
  width: 95%;
  box-shadow: var(--shadow);
  max-height: 90vh;
  overflow-y: auto;
}
.close-btn {
  float: right;
  background: none;
  border: none;
  color: #a44;
  font-size: 1.4em;
  cursor: pointer;
}

/* ==== –≠–∫—Å–ø–æ—Ä—Ç, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==== */
.export {
  background: var(--color-bg-export);
  padding: .7em .8em;
  border-radius: var(--radius-export);
  margin-top: .6em;
  color: var(--color-txt-export);
}
.setting-row {
  display: flex;
  align-items: center;
  gap: 7px;
  margin: .5em 0;
}
select,
input[type=number] {
  font-size: 1em;
  padding: .2em .3em;
  border-radius: 8px;
  border: 1px solid #bbb;
}
.sw-btn {
  margin: .1em .2em;
}

/* ==== –°–æ—Å—Ç–æ—è–Ω–∏—è –æ—à–∏–±–æ–∫ ==== */
input.input-error {
  border: 2px solid var(--color-txt-error) !important;
  background: var(--color-input-error) !important;
  animation: shake 0.4s;
}

/* ==== –ê–ù–ò–ú–ê–¶–ò–ò ==== */
@keyframes shake {
  0% { transform: translateX(0px);}
  20% { transform: translateX(-5px);}
  40% { transform: translateX(5px);}
  60% { transform: translateX(-4px);}
  80% { transform: translateX(4px);}
  100% { transform: translateX(0px);}
}

/* ==== –ú–ï–î–ò–ê ---- –ú–æ–±–∏–ª–∫–∏, –∞–¥–∞–ø—Ç–∏–≤ ==== */
@media (max-width: 400px) {
  :root {
    --footer-height: 48px;
  }
  .container {
    padding: .5em .3em;
    margin-top: 1vh;
  }
  h1 {
    font-size: 1.3rem;
  }
  .btn {
    font-size: 1rem;
    padding: .6em .2em;
  }
  .footer-btn span {
    font-size: 0.70em;
  }
  .footer-btn {
    font-size: 1.02em;
  }
}

/* ==== –î–†–£–ì–û–ô –ú–ï–î–ò–ê-–ö–í–ï–†–ò –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ ==== */
@media (min-width: 401px) {
  .container {
    margin-top: 6vh;
  }
}
  </style>
</head>
<body>
<div class="container" id="app"></div>


<div class="footer-bar">
  <button class="footer-btn" onclick="showCalendar()">üìÖ<br><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
  <button class="footer-btn" onclick="showExport()">‚§ì<br><span>–≠–∫—Å–ø–æ—Ä—Ç</span></button>
  <button class="footer-btn" onclick="showSettings()">‚öôÔ∏è<br><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></button>
  <button class="footer-btn" onclick="showAbout()">?<br><span>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span></button>
</div>

  
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤/–≤—Ä–µ–º–µ–Ω–∏/—ç–∫—Å–ø–æ—Ä—Ç/–æ—Ç—á–µ—Ç) -->
<div id="modal" style="display:none;"></div>

<script>
/* ==== Data structure and helpers ==== */
const STORAGE_KEY = "myworkdays22";
const DEFAULT_TAG = "–ù–ê–°–¢–†–û–ô–ö–ê –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø";
let days = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); // [{date, start, end, tags:[{tag, start, end}]}]

let tagsLib = JSON.parse(localStorage.getItem("tagsLib22")||"[]");
// –ï—Å–ª–∏ —Ç–µ–≥–æ–≤ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π, –∏–Ω–∞—á–µ ‚Äî —Å–ª–µ–¥–∏–º, —á—Ç–æ–±—ã –æ–Ω –≤—Å–µ–≥–¥–∞ –±—ã–ª –ø–µ—Ä–≤—ã–º
if (!Array.isArray(tagsLib) || tagsLib.length === 0) {
  tagsLib = [DEFAULT_TAG];
} else if (!tagsLib.includes(DEFAULT_TAG)) {
  tagsLib.unshift(DEFAULT_TAG);
}

function saveAll() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(days));
  localStorage.setItem("tagsLib22", JSON.stringify(tagsLib));
}

function findDay(date) {
  return days.find(d => d.date === date);
}

function todayStr() {
  return (new Date()).toISOString().slice(0,10);
}

function toHM(dt) {
  // dt: "09:25", returns [9,25]
  let [h,m] = dt.split(":").map(Number); return [h,m];
}

function fromHM(h, m) {
  // int,int => "09:25"
  return (h<10?'0':'')+h+":"+(m<10?'0':'')+m;
}

// –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã –≤ –≤—Ä–µ–º–µ–Ω–∏ (–≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑/–æ—Ç–±—Ä–æ—Å)
function roundTime(timeStr, roundMin=10, direction='round') {
  let [h, m] = toHM(timeStr);
  let total = h*60+m;
  let q = total / roundMin;
  let res;
  if(direction==='down') res = Math.floor(q);
  else if(direction==='up') res = Math.ceil(q);
  else res = Math.round(q);
  total = res*roundMin;
  h = Math.floor(total/60);
  m = total%60;
  return fromHM(h, m);
}

// –†–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (—á—á:–º–º ‚Üí –º–∏–Ω—É—Ç—ã)
function diffMinutes(tm1, tm2) {
  let [h1,m1] = toHM(tm1), [h2,m2]=toHM(tm2);
  return (h2*60+m2)-(h1*60+m1);
}

// ===== UI render =====

function renderApp() {
  let dt = todayStr();
  let day = findDay(dt);
  let rows = [];
  rows.push(`<h1>–ú–æ–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</h1>`);
  rows.push(`
    <div class="row">
      <div class="dual-btn">
        <button class="btn" onclick="markNow('start')">
          ‚ûî ${day?.start || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø</div>
        </button>
        <button class="btn" onclick="openManualTime('start')">
          üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨ –í–†–ï–ú–Ø</div>
        </button>
      </div>
      <div class="dual-btn">
        <button class="btn" onclick="markNow('end')">
          ‚è± ${day?.end || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø</div>
        </button>
        <button class="btn" onclick="openManualTime('end')">
          üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨ –í–†–ï–ú–Ø</div>
        </button>
      </div>
    </div>
  `);
  // DURATION
  if(day?.start && day?.end) {
    let time = diffMinutes(day.start, day.end);
    rows.push(`<div class="center"><span class="badge">${Math.floor(time/60)}—á ${(time%60).toString().padStart(2,"0")}–º</span> –æ–±—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</div>`);
  }
  // TAGS-list
  rows.push(`<hr><div><b>–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> <button class="edit" onclick="editTags()">+–¢–µ–≥</button></div>`);
  if(day?.tags?.length) {
    rows.push(`<ul class="tags-list">`+
      day.tags.map((t,i)=>`<li><b>${t.tag}</b> ‚Äî ${t.start}‚Ä¶${t.end} 
      <button class="edit" onclick="editTag(${i})">‚úé</button> 
      <button class="edit" onclick="delTag(${i})">‚úï</button>
      </li>`).join('')+
      `</ul>`);
  } else {
    rows.push(`<div class="small">–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>`);
  }
  rows.push(`<hr>`);
  // –ö–ê–õ–ï–ù–î–ê–†–¨ –¥–æ –æ—Ç—á–µ—Ç–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  //  rows.push(`<div class="row"><button class="btn" onclick="showCalendar()">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button><button class="btn" onclick="showExport()">–≠–∫—Å–ø–æ—Ä—Ç</button></div>`);
  //  rows.push(`<div class="row"><button class="btn" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button><button class="btn" onclick="showAbout()">?</button></div>`);
  document.getElementById('app').innerHTML = rows.join('\n');
  closeModal();
}
window.renderApp = renderApp;

// ===================== MARK HANDLERS ========================
function markNow(type) {
  let dt = todayStr();
  let now = new Date();
  let h = now.getHours(), m = now.getMinutes();
  let tstr = fromHM(h, m);
  let day = findDay(dt);
  if(!day) {
    day = {date: dt, start: '', end: '', tags:[]};
    days.push(day);
  }
  day[type] = tstr;
  saveAll(); renderApp();
}

function openManualTime(type) {
  let dt = todayStr();
  let day = findDay(dt) || { date: dt, start: '', end: '', tags: [] };

  // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Ç–µ–∫—É—â–µ–µ –∏–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
  let val = (day[type] && /^\d\d:\d\d$/.test(day[type]))
    ? day[type]
    : (() => {
        let d = new Date(), h = d.getHours(), m = d.getMinutes();
        return (h<10?'0':'')+h+":"+(m<10?'0':'')+m;
      })();

  let label = type === "start" ? "–í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞" : "–í—Ä–µ–º—è —É—Ö–æ–¥–∞";
  let html = `
    <form id="manualTimeForm">
      <label>${label}:<br>
        <input type="time" id="manualTimeInput" value="${val}" required>
      </label>
      <div class="row" style="margin-top:16px;">
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn fullw" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  `;
  showModal(html);

  document.getElementById('manualTimeForm').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('manualTimeInput');
    const t = input.value.trim();
    if (!t) {
      input.classList.add('input-error');
      input.focus();
      setTimeout(() => input.classList.remove('input-error'), 1000);
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!');
      return;
    }
    let curday = findDay(dt);
    if(!curday) { curday = { date: dt, start: '', end: '', tags: [] }; days.push(curday); }
    curday[type] = t;
    saveAll();
    renderApp();
  };
} 

function editTags() {
  // –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥
  let dt = todayStr(); let day = findDay(dt);
  if(!day) {alert("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—Ç—å—Ç–µ –≤—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞ (–∏ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —É—Ö–æ–¥–∞)!");return;}
  showTagModal(null, dt);
}
function editTag(idx) {
  let dt = todayStr(); let day = findDay(dt);
  showTagModal(idx, dt);
}
function delTag(idx) {
  let dt = todayStr(); let day = findDay(dt);
  if(day && day.tags && day.tags[idx] !== undefined) {
    if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "+day.tags[idx].tag+"?")) {
      day.tags.splice(idx,1);
      saveAll();
      renderApp();
    }
  }
}
  
// tagIdx: null ‚Äî –Ω–æ–≤—ã–π, int ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
function showTagModal(tagIdx, forDate) {
  let day = findDay(forDate); 
  if (!day) return;

  // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ–≥–¥–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–µ–≥.
  let tagObj;
  if (tagIdx !== null && day.tags[tagIdx]) {
    tagObj = { ...day.tags[tagIdx] };
  } else {
    tagObj = { tag: DEFAULT_TAG, start: day.start || "09:00", end: day.end || "18:00" };
  }

  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–µ–≥ –ø–µ—Ä–≤—ã–º, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –¥–∞–ª—å—à–µ
  let tagOptions = [DEFAULT_TAG, ...tagsLib.filter(t => t !== DEFAULT_TAG)]
    .map(t => `<option value="${t}"></option>`).join("");

  let html = `
    <form id="tagForm">
      <label>–¢–µ–≥:<br>
        <input type="text" list="tagsSug" value="${tagObj.tag || ''}" id="tg" required autocomplete="off">
        <datalist id="tagsSug">${tagOptions}</datalist>
      </label><br>
      <label>–ù–∞—á–∞–ª–æ:<br>
        <input type="time" id="st" value="${tagObj.start}" required>
      </label><br>
      <label>–ö–æ–Ω–µ—Ü:<br>
        <input type="time" id="en" value="${tagObj.end}" required>
      </label><br>
      <div class="row">
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </form>
  `;
  showModal(html);

  document.getElementById('tagForm').onsubmit = function(e) {
    e.preventDefault();
    let tg = document.getElementById('tg').value.trim();
    let st = document.getElementById('st').value, en = document.getElementById('en').value;
    if (!tg) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥");
    if (!tagsLib.includes(tg)) tagsLib.push(tg);
    if (tagIdx !== null) day.tags[tagIdx] = { tag: tg, start: st, end: en };
    else day.tags.push({ tag: tg, start: st, end: en });
    saveAll();
    renderApp();
  };
}

// ===== –ö–ê–õ–ï–ù–î–ê–†–¨ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–Ω–µ–π ======
function showCalendar(mon=null, yr=null) {
  // –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞ –º–µ—Å—è—Ü c –ø–æ–º–µ—Ç–∫–∞–º–∏ –≥–¥–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏, –∫–ª–∏–∫ –ø–æ –¥–Ω—é ‚Äî –¥–µ—Ç–∞–ª–∏ –¥–Ω—è
  let now = new Date();
  let year = yr || now.getFullYear();
  let month = mon!==null ? mon : now.getMonth(); // 0-based
  let first = new Date(year,month,1);
  let last = new Date(year,month+1,0);
  let daysNum = last.getDate();
  let content = `<div style='text-align:center'>${["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"][month]} ${year}</div>`;
  content += `<div class="row" style="flex-wrap:wrap;justify-content:center">`;
  for(let i=1;i<=daysNum;i++){
    let ds = `${year}-${(month+1).toString().padStart(2,"0")}-${i.toString().padStart(2,"0")}`;
    let hasData = days.some(d=>d.date===ds);
    content+=`<button class="cal-btn${hasData?' selected':''}" onclick="showDay('${ds}')">${i}</button>`;
  }
  content += `</div><div class='center'><button class="sw-btn" onclick="showCalendar(${month-1<0?11:month-1},${month-1<0?year-1:year})">‚Üê</button>
  <button class="sw-btn" onclick="showCalendar(${month+1>11?0:month+1},${month+1>11?year+1:year})">‚Üí</button></div>`;
  content += `<div class='center'><button class="btn fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  showModal(content);
}
function showDay(ds) {
  let day = findDay(ds);
  let html = `<b>${ds}</b><br>
  –í—Ä–µ–º—è: ${day?.start || '‚Äî'} ‚Äî ${day?.end || '‚Äî'}<br>
  ${
    day?.tags?.length ?
     `<ul class="tags-list">`+
      day.tags.map((t,i)=>`<li><b>${t.tag}</b> ${t.start}‚Ä¶${t.end}</li>`).join('')+
      `</ul>`: '<div class="small">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>'
  }
  <div class='center'><button class="btn" onclick="closeModal()">–ù–∞–∑–∞–¥</button></div>
  `;
  showModal(html);
}

// ===== –≠–ö–°–ü–û–†–¢ –û–¢–ß–ï–¢–ê =================
function showExport() {
  // Settings: –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç, –≤—ã–±—Ä–∞—Ç—å —á—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ç–∏–ø –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è, –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑/–æ–±—ã—á–Ω–æ
  let minDate = days.length?days[0].date:todayStr();
  let maxDate = days.length?days[days.length-1].date:todayStr();
  let html = `
    <div><b>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</b></div>
    <form id="reportForm">
      <div class="setting-row">–ü–µ—Ä–∏–æ–¥: 
        <select id="per">
          <option value="1-15">1‚Äì15</option>
          <option value="16-31">16‚Äì31</option>
          <option value="full">–í–µ—Å—å –º–µ—Å—è—Ü</option>
          <option value="range">–ü–µ—Ä–∏–æ–¥</option>
        </select>
        <input type="date" id="dfrom" style="display:none" value="${minDate}"> -
        <input type="date" id="dto" style="display:none" value="${maxDate}">
      </div>
      <div class="setting-row">–≠–∫—Å–ø–æ—Ä—Ç:
        <select id="expType">
          <option value="all">–í—Å—ë</option>
          <option value="tags">–¢–æ–ª—å–∫–æ —Ç–µ–≥–∏</option>
          <option value="work">–¢–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã (–ø—Ä–∏—Ö–æ–¥/—É—Ö–æ–¥)</option>
        </select>
      </div>
      <div class="setting-row">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ:
        <select id="roundM">
          <option value="60">–î–æ 1 —á–∞—Å–∞</option>
          <option value="30">–î–æ 30 –º–∏–Ω</option>
          <option value="10" selected>–î–æ 10 –º–∏–Ω</option>
        </select>
        <select id="roundDir">
          <option value="round">–û–±—ã—á–Ω–æ</option>
          <option value="up">–í–≤–µ—Ä—Ö</option>
          <option value="down">–í–Ω–∏–∑</option>
        </select>
      </div>
      <div class="setting-row">–¢–µ–≥–∏: <select multiple id="tagsFlt" style="min-width:70px;min-height:2em;">
        ${tagsLib.map(t=>`<option value="${t}" selected>${t}</option>`).join("")}
      </select> <span class="small">(–¥–ª—è —Ä–µ–∂–∏–º–∞ "—Ç–µ–≥–∏")</span></div>
      <button class="btn fullw" type="submit">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn fullw" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </form>
    <div id="exportResult"></div>
  `;
  showModal(html);
  let perSel = document.getElementById("per");
  let fromD = document.getElementById("dfrom");
  let toD = document.getElementById("dto");
  perSel.onchange = function() {
    if(perSel.value==='range'){
      fromD.style.display='inline';
      toD.style.display='inline';
    } else {
      fromD.style.display='none';
      toD.style.display='none';
    }
  }
  document.getElementById("reportForm").onsubmit = function(e) {
    e.preventDefault();
    // Params
    let period = perSel.value;
    let from = fromD.value || minDate;
    let to = toD.value || maxDate;
    let exp = document.getElementById("expType").value;
    let roundM = +document.getElementById("roundM").value;
    let roundDir = document.getElementById("roundDir").value;
    // select tags
    let tagsFlt = Array.from(document.getElementById("tagsFlt").selectedOptions).map(op=>op.value);

    // –î–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞
    // –ü–æ–ª—É—á–∞–µ–º –Ω—É–∂–Ω—ã–µ –¥–Ω–∏
    let list, byMonth = {};
    if (period === "1-15") {
      list = days.filter(d=>+d.date.slice(8,10)<=15 && inThisMonth(d.date));
    } else if(period === "16-31") {
      list = days.filter(d=>+d.date.slice(8,10)>=16 && inThisMonth(d.date));
    } else if(period === "range") {
      list = days.filter(d=>d.date >= from && d.date <= to);
    } else { // full
      list = days.filter(d=>inThisMonth(d.date));
    }
    function inThisMonth(dt) {
      let selm = days.length ? days[days.length-1].date.slice(5,7) : todayStr().slice(5,7);
      return dt.slice(5,7)===selm;
    }

    let rows = [];
    if(exp==='work'||exp==='all'){
      // —Ç–∞–±–ª–∏—Ü–∞: –î–∞—Ç–∞: –ü—Ä–∏—Ö–æ–¥ - –£—Ö–æ–¥ = X —á Y –º–∏–Ω
      for(const d of list) {
        let s = d.start?roundTime(d.start, roundM, roundDir):"", e = d.end?roundTime(d.end, roundM, roundDir):"";
        if(!s || !e) continue;
        let mins = diffMinutes(s,e);
        let hr = Math.floor(mins/60), mn = mins%60;
        rows.push(`${d.date}: ${s} ‚Äì ${e} (${hr}—á ${mn}–º)`);
      }
    }
    if(exp==='tags'||exp==='all'){
      for(const d of list) {
        if(!d.tags?.length) continue;
        // —Ñ–∏–ª—å—Ç—Ä —Ç–µ–≥–æ–≤:
        for(const tag of d.tags) {
          if(tagsFlt.includes(tag.tag)){
            let st = roundTime(tag.start, roundM, roundDir), en = roundTime(tag.end, roundM, roundDir);
            let mins = diffMinutes(st, en);
            let hr = Math.floor(mins/60), mn = mins%60;
            rows.push(`${d.date}: ${tag.tag} ‚Äî ${st}-${en} (${hr}—á ${mn}–º)`);
          }
        }
      }
    }
    let resTxt = rows.join('\n');
    document.getElementById("exportResult").innerHTML =
      `<div class="export"><b>–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç:</b><br>
      <textarea style="width:98%;min-height:120px">${resTxt}</textarea>
      <br>
      <button class="btn" type="button" onclick="downloadText()">–°–∫–∞—á–∞—Ç—å .txt</button>
      </div>`;
    window.export__text = resTxt;
    return false;
  };
}
function downloadText() {
  let b = new Blob([window.export__text || ""], {type:"text/plain"});
  let link = document.createElement("a");
  link.href = URL.createObjectURL(b);
  link.download = "work_report.txt";
  link.click();
}

function showSettings() {
  let html = `
    <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>
    <ul class="tags-list">
      <li><b>–ú–æ–∏ —Ç–µ–≥–∏:</b></li>
      ${tagsLib.map((t, i) => `
        <li style="margin-bottom:6px;">
          <span class="badge">${t}</span>
          ${i === 0
            ? '<span class="small">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)</span>'
            : `<button class="edit" onclick="removeTagLib(${i})">‚úï —É–¥–∞–ª–∏—Ç—å</button>`}
        </li>
      `).join("")}
      <li>
        <input type="text" id="newTgInp" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥...">
        <button class="btn" onclick="addTagFromSettings()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </li>
      <li>
        <button class="btn" onclick="resetAllData()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <span class="small">(–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ)</span>
      </li>
    </ul>
    <button class="btn fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  `;
  showModal(html);
}

function addTagFromSettings() {
  let inp = document.getElementById('newTgInp');
  let newTag = inp.value.trim();
  if(!newTag) return;
  if(!tagsLib.includes(newTag)) {
    tagsLib.push(newTag);
    saveAll();
    closeModal();
    renderApp();
  }
}

function removeTagLib(i) {
  if (i === 0) return; // –Ω–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–≥
  if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${tagsLib[i]}"? –í—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º —Ç–µ–≥–æ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è, –Ω–æ –Ω–æ–≤—ã–π –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.`)) {
    tagsLib.splice(i, 1);
    saveAll();
    showSettings();
    renderApp();
  }
}

function resetAllData() {
  if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
    days = [];
    tagsLib = [DEFAULT_TAG]; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É —Ç–µ–≥—É
    saveAll();
    closeModal();
    renderApp();
  }
}

const APP_VERSION = "1.0.0 (2024-06-05)"; // –≤–µ—Ä—Å–∏—é –∏ –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ

function showAbout() {
  let html = `
    <b>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</b><br>
    <div class="small" style="line-height:1.7;">
      <b>–ê–≤—Ç–æ—Ä –∏–¥–µ–∏:</b> –ê–Ω—Ç–æ–Ω –ú–∞–≥–æ–º–µ–¥–æ–≤<br>
      <b>Telegram / Instagram:</b> <a href="https://t.me/xcve33" target="_blank">@xcve33</a><br>
      <b>Email:</b> <a href="mailto:akitsatnafiya@gmail.com">akitsatnafiya@gmail.com</a><br>
      <b>GitHub:</b> <a href="https://github.com/sunpole" target="_blank">sunpole</a><br>
      <br>
      <b>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞:</b><br>
      –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ ‚Äî —á–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ <a href="https://www.sider.ai/" target="_blank">sider.ai</a>, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ—Ä–∏–∏ –ø—Ä–æ–º—Ç–æ–≤ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –æ—Ç –∞–≤—Ç–æ—Ä–∞.<br>
      –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —á–µ—Å—Ç–Ω–æ –∏ —Ä–∞–¥–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —Å AI.<br>
      <br>
      <b>–í–µ—Ä—Å–∏—è:</b> ${APP_VERSION}<br>
      <b>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</b><br>
      –¢—Ä–µ–∫–µ—Ä —É—á—ë—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞, —É—Ö–æ–¥–∞ –∏ –≤–∏–¥–æ–≤ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ —Ç–µ–≥–∞–º.<br>
      <br>
      <b>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</b><br>
      ‚Äî –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (LocalStorage –±—Ä–∞—É–∑–µ—Ä–∞)<br>
      ‚Äî –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞<br>
      ‚Äî –ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç—ã –≤ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏<br>
      <br>
      <b>–í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞.</b><br>
      –õ—é–±–∞—è –≤–∞—à–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –æ—Ç–∑—ã–≤ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—á–µ–Ω—å —Ü–µ–Ω–Ω—ã –¥–ª—è –º–µ–Ω—è.<br>
      <br>
      <button class="btn" style="font-size:0.98em;white-space:normal;line-height:1.1;padding:0.7em 1em;" onclick="closeModal()">–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ</button>
    </div>
  `;
  showModal(html);
}


function showModal(html) {
  let m = document.getElementById("modal");
  m.innerHTML = `<div class="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">${html}</div>
  </div>`;
  m.style.display = '';
}
function closeModal(e) {
  if(e && e.target!==document.getElementById("modal"))return;
  document.getElementById("modal").style.display='none';
}

renderApp();
</script>
</body>
</html>
