<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!-- –ò–ö–û–ù–ö–ò (–ª–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ) -->
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="manifest" href="site.webmanifest" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <title>–¢–∞–π–º-—Ç—Ä–µ–∫–µ—Ä | –ú–æ–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</title>

  <style>
:root {
  /* ------ –¶–≤–µ—Ç–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ) ------ */
  --color-accent:           #3a7afe;
  --color-accent-hover:     #236dfc;
  --color-accent-light:     #b3d1fd;
  --color-accent-xlight:    #e4eaff;
  --color-bg:               #eef3fa;
  --color-bg-white:         #fff;
  --color-bg-footer:        #f5f8fe;
  --color-bg-btn-active:    #e4eaff;
  --color-bg-dual-btn:      #cafaff;
  --color-bg-dual-btn-last: #e4eaff;
  --color-bg-calendar:      #e8f1ff;
  --color-bg-export:        #fffbe7;
  --color-input-error:      #ffe7e7;

  --color-txt:           #222;
  --color-txt-grey:      #555;
  --color-txt-accent:    #2995fa;
  --color-txt-small:     #888;
  --color-txt-export:    #993;
  --color-txt-calendar:  #217;
  --color-txt-badge:     #fff;
  --color-txt-error:     #ff4343;

  /* –û—Å—Ç–∞–ª—å–Ω–æ–µ */
  --radius-main:      18px;
  --radius-calendar:  12px;
  --radius-export:    14px;
  --radius-badge:     8px;
  --shadow:           0 3px 20px #0001;
  --footer-height:    66px;

  --container-padding-v: 1.5rem;
  --container-padding-h: 1rem;
  --container-padding-bottom: 90px;
}

/* ----- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ----- */
body.dark-theme {
  --color-accent:           #4f8dff;
  --color-accent-hover:     #266ce5;
  --color-accent-light:     #3666e680;
  --color-accent-xlight:    #262c3f;
  --color-bg:               #23252a;
  --color-bg-white:         #23252a;
  --color-bg-footer:        #242830;
  --color-bg-btn-active:    #313641;
  --color-bg-dual-btn:      #242830;
  --color-bg-dual-btn-last: #323844;
  --color-bg-calendar:      #2a2d35;
  --color-bg-export:        #191b16;
  --color-input-error:      #691818;
  --color-txt:           #f4f6fd;
  --color-txt-grey:      #aab2c8;
  --color-txt-accent:    #8bb8ff;
  --color-txt-small:     #8d99b4;
  --color-txt-export:    #cca;
  --color-txt-calendar:  #9ac2ff;
  --color-txt-badge:     #fff;
  --color-txt-error:     #ff4343;
}

/* === –ë–∞–∑–æ–≤–∞—è —Å–µ—Ç–∫–∞ –∏ –ø–ª–∞–≤–Ω–æ—Å—Ç—å === */
body, .container, .footer-bar, .btn, .dual-btn, .modal-inner, .export {
  transition: background .22s, color .22s, border-color .22s;
}
body {
  background: var(--color-bg);
  color: var(--color-txt);
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
}

.container {
  padding: var(--container-padding-v) var(--container-padding-h);
  padding-bottom: var(--container-padding-bottom);
  max-width: 480px;
  margin: auto;
  background: var(--color-bg-white);
  border-radius: var(--radius-main);
  margin-top: 3vh;
  box-shadow: var(--shadow);
}
h1 {
  margin: 0 0 12px;
  font-size: 2rem;
  font-weight: bold;
  color: var(--color-accent);
  text-align: center;
}

/* ===== FLEX GRID/COMMON ===== */
.row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
  align-items: stretch;
}
.row-col {
  flex-direction: column;
  gap: 6px;
}
.fullw { width:100%; display:block; }
.center { text-align:center; }
hr { margin:16px 0; }

/* ========== –ö–∞—Å—Ç–æ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º ========== */
/* --- –ß–ï–ö–ë–û–ö–°–´ --- */
input[type="checkbox"] {
  appearance: none; -webkit-appearance: none;
  width:40px; height:24px; border-radius:16px;
  background: var(--color-bg-dual-btn);
  border:2px solid var(--color-accent-light);
  position: relative;
  outline: none; cursor: pointer;
  vertical-align: middle;
  transition: background .18s, border-color .22s;
  margin-right:10px; box-shadow:none;
}
input[type="checkbox"]:checked {
  background: var(--color-accent);
  border-color: var(--color-accent);
}
input[type="checkbox"]::before {
  content:''; position:absolute; left:3px; top:3px;
  width:16px; height:16px; border-radius:50%;
  background: var(--color-bg-white);
  transition: transform .18s, background .22s;
  box-shadow: 0 2px 7px #0001;
}
input[type="checkbox"]:checked::before {
  transform: translateX(16px);
  background: var(--color-bg-white);
}
input[type="checkbox"]:focus-visible {
  outline:2px solid var(--color-accent); outline-offset:2px;
}

/* --- SELECT --- */
select {
  appearance: none; -webkit-appearance: none;
  background: var(--color-bg-dual-btn);
  color: var(--color-txt);
  border:2px solid var(--color-accent-light);
  border-radius:12px;
  font-size:1em;
  padding: 0.46em 2.2em 0.46em 0.8em;
  outline: none;
  margin-right:7px; min-width:70px;
  transition: background .22s, color .22s, border-color .22s;
  box-shadow: none; cursor:pointer; position:relative;
}
select:focus-visible, select:focus { border-color:var(--color-accent); }
select[multiple] { min-height:2.4em; }
select:not([multiple]) {
  background-image: url('data:image/svg+xml;utf8,<svg height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M4 7l5 5 5-5" stroke="%23666" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
  background-repeat:no-repeat;
  background-position:right 0.7em center;
  background-size: 1.2em 1.2em;
}
body.dark-theme select:not([multiple]) {
  background-image: url('data:image/svg+xml;utf8,<svg height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M4 7l5 5 5-5" stroke="%23aabafc" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>');
}

/* --- NUMBER / TEXT / TIME INPUT --- */
input[type="number"], input[type="text"], input[type="time"], input[type="date"] {
  background: var(--color-bg-dual-btn);
  color: var(--color-txt);
  border:2px solid var(--color-accent-light);
  border-radius:10px; font-size:1em;
  padding:0.46em 0.8em; outline:none;
  margin-right:5px; box-shadow:none;
  transition: background .22s, color .22s, border-color .22s;
}
input[type="number"]:focus,
input[type="text"]:focus,
input[type="time"]:focus,
input[type="date"]:focus { border-color: var(--color-accent); }

/* --- Input Error --- */
input.input-error {
  border: 2px solid var(--color-txt-error) !important;
  background: var(--color-input-error) !important;
  animation: shake .4s;
}

/* ==== –ö–ù–û–ü–ö–ò ==== */
.btn {
  background:var(--color-bg-white);
  border:2px solid var(--color-accent);
  color:var(--color-accent);
  border-radius:var(--radius-main);
  font-size:1.15rem; padding:0.9em 1em;
  flex: 1 1 auto; font-weight:600;
  cursor:pointer; transition:.12s;
  box-shadow:var(--shadow);
  touch-action: manipulation;
  user-select: none;
}
.btn:hover { filter: brightness(0.98); }
.btn:active {
  transform: translateY(1px);
  background:var(--color-bg-btn-active);
}
.btn-sub {
  font-size:.76em; color:var(--color-txt-accent);
  margin-top:2px; font-weight:400;
  letter-spacing:.02em; line-height:1;
}

.dual-btn {
  display:flex; flex-direction:row; flex:1 1 0;
  border-radius:var(--radius-main); overflow:hidden;
  border:2px solid var(--color-accent);
}
.dual-btn .btn {
  border:none; border-radius:0; font-size:1.1rem;
  background:var(--color-bg-white);
  color:var(--color-accent);
  box-shadow:none; flex:1 1 0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  min-width:0; padding:0.8em 0.6em;
}
.dual-btn .btn:first-child { border-right:1px solid var(--color-accent-light); background:var(--color-bg-dual-btn);}
.dual-btn .btn:last-child  { background:var(--color-bg-dual-btn-last);}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
.btn-cancel {
  border-color:#e26a6a;
  color:#e26a6a;
  background:#fff5f5;
}
body.dark-theme .btn-cancel {
  background:#3a2a2a;
  color:#ff9d9d;
  border-color:#a95353;
}
.btn-secondary {
  border-color:#8aa0c4;
  color:#5b7db8;
  background:#eef3ff;
}
body.dark-theme .btn-secondary {
  background:#293247;
  border-color:#3f5a8a;
  color:#96b7ff;
}

/* –ö–Ω–æ–ø–∫–∞-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–∞—è */
.edit {
  background:none; border:2px solid transparent;
  color:var(--color-accent);
  font-size:1.2em; cursor:pointer; margin-left:6px;
  border-radius:10px; padding:.1em .35em;
}
.edit:focus-visible { outline:2px solid var(--color-accent); }

/* ===== –¢–µ–≥–∏ –∏ —Å–ø–∏—Å–∫–∏ ===== */
.tags-list { margin:.4em 0 0; padding:0; list-style:none;}
.tags-list li { padding:.2em 0; }
.badge {
  background:var(--color-accent);
  color:var(--color-txt-badge);
  border-radius:var(--radius-badge);
  padding:.1em .7em; font-size:1em;
}
.small { font-size:.92em; color:var(--color-txt-small); }

/* ==== –ö–∞–ª–µ–Ω–¥–∞—Ä—å ==== */
.calendar {
  width:100%;
}
.cal-head {
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:6px;
  margin:8px 0 6px;
  font-weight:700;
  text-align:center;
  user-select:none;
}
.cal-head div {
  padding:.35em 0;
  border-radius:10px;
  background: var(--color-bg-calendar);
  color: var(--color-txt-calendar);
  border: 1px solid var(--color-accent-light);
}
.cal-grid {
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:6px;
}
.cal-btn {
  font-size:1rem; padding:.55em 0;
  border-radius:12px;
  background:var(--color-bg-white);
  border: 1.8px solid var(--color-accent-light);
  color: var(--color-txt);
  cursor:pointer; min-height:42px;
  position:relative;
}
.cal-btn:hover { filter:brightness(0.98); }
.cal-btn.selected { border-color: var(--color-accent); background:var(--color-accent-xlight); }
.cal-btn .daynum { font-weight:700; }
.cal-btn .dot {
  position:absolute; right:6px; top:6px; width:8px; height:8px; border-radius:50%;
  background: var(--color-accent);
}
.cal-btn.is-weekend { color:#c23; border-color:#f3caca; }
body.dark-theme .cal-btn.is-weekend { color:#ff9d9d; border-color:#5a3737; }
.cal-empty {
  min-height:42px; border-radius:12px; border:1px dashed transparent;
}

/* ==== –ö–ù–û–ü–ö–ò –í –ü–û–î–í–ê–õ–ï ==== */
.footer-bar {
  position: fixed; left:0; right:0; bottom:0;
  background: var(--color-bg-footer);
  border-top: 1px solid var(--color-accent-light);
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  z-index: 10; height: var(--footer-height);
}
.footer-btn {
  display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px;
  padding:8px 6px;
  margin:4px;
  background: var(--color-bg-white);
  border:2px solid var(--color-accent);
  border-radius:14px;
  font-size:1rem;
  color: var(--color-accent);
  cursor:pointer; outline:none;
  user-select:none; touch-action:manipulation;
}
.footer-btn:active, .footer-btn:focus { background:var(--color-bg-btn-active);}
.footer-btn .ico {
  width:24px; height:24px; flex:0 0 24px;
}
.footer-btn span {
  font-size:0.92em; color:var(--color-txt-grey);
  font-weight:600;
}

/* ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ==== */
.modal {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: #0003; z-index:22;
  display:flex; align-items:center; justify-content:center;
}
.modal-inner {
  scroll-behavior: smooth; background:var(--color-bg-white);
  padding:1.2em; border-radius:20px;
  max-width:420px; width:95%;
  box-shadow:var(--shadow);
  max-height:90vh; overflow-y:auto;
}
.modal-title { font-weight:800; margin-bottom:.4em; }

/* ==== –≠–∫—Å–ø–æ—Ä—Ç ==== */
.export {
  background:var(--color-bg-export);
  padding:.7em .8em; border-radius:var(--radius-export);
  margin-top:.6em; color:var(--color-txt-export);
  box-shadow: 0 2px 12px #d7dcaf29;
}
.export textarea {
  border-radius:9px; outline:none;
  border:1.2px solid var(--color-accent-xlight);
  background: #fffdec;
  padding:.7em .9em; font-size:1em;
  width:98%; min-height:110px; margin-bottom: 8px;
  box-shadow: 0 1px 6px #b7b07130; color:#625440; resize:vertical;
}
body.dark-theme .export textarea { background:#24241e; color:#dcc; }
.export .btn { margin-top:7px; font-size:1em; padding:.5em 1em; border-radius:10px; }
.export .btn:first-of-type { margin-top:12px; }

/* ==== –†—è–¥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ==== */
.setting-row { display:flex; align-items:center; gap:7px; margin:.5em 0; }

/* ==== –ê–Ω–∏–º–∞—Ü–∏–∏ ==== */
@keyframes shake {
  0% {transform:translateX(0px);}
  20%{transform:translateX(-5px);}
  40%{transform:translateX(5px);}
  60%{transform:translateX(-4px);}
  80%{transform:translateX(4px);}
  100%{transform:translateX(0px);}
}

/* ==== –ê–¥–∞–ø—Ç–∏–≤ ==== */
@media (max-width: 420px) {
  :root { --footer-height: 86px; --container-padding-bottom: 110px; }
  .container { padding:.7em .5em; margin-top:1vh; }
  h1 { font-size:1.45rem; }
  .btn { font-size:1rem; padding:.7em .6em; }
  .footer-bar { grid-template-columns: repeat(2, 1fr); row-gap:2px; }
  .footer-btn { gap:8px; }
}
@media (min-width: 421px) {
  .container { margin-top:6vh;}
}
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –±–æ–ª—å—à–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –∏ SVG-–∏–∫–æ–Ω–∫–∞–º–∏ -->
  <div class="footer-bar" role="toolbar" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <button class="footer-btn" onclick="showCalendar()" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
      <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M7 2v3M17 2v3M3 9h18M4 6h16a1 1 0 011 1v13a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
    </button>

    <button class="footer-btn" onclick="showExport()" aria-label="–≠–∫—Å–ø–æ—Ä—Ç">
      <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3v12M7 10l5 5 5-5M5 21h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
    </button>

    <button class="footer-btn" onclick="showSettings()" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
      <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 15a3 3 0 100-6 3 3 0 000 6zm7.94-2a7.96 7.96 0 00.06-1 7.96 7.96 0 00-.06-1l2.06-1.6a.5.5 0 00.12-.64l-2-3.46a.5.5 0 00-.6-.22l-2.43.98a8.04 8.04 0 00-1.74-1.01L13.5 2.5a.5.5 0 00-.5-.5h-4a.5.5 0 00-.5.5L8 5.05a8.04 8.04 0 00-1.74 1.01l-2.43-.98a.5.5 0 00-.6.22l-2 3.46a.5.5 0 00.12.64L3.4 10a7.96 7.96 0 00-.06 1 7.96 7.96 0 00.06 1l-2.05 1.6a.5.5 0 00-.12.64l2 3.46a.5.5 0 00.6.22l2.43-.98c.54.42 1.12.77 1.74 1.01L8 21.5a.5.5 0 00.5.5h4a.5.5 0 00.5-.5l.5-2.55c.62-.24 1.2-.59 1.74-1.01l2.43.98a.5.5 0 00.6-.22l2-3.46a.5.5 0 00-.12-.64L19.94 13z" fill="currentColor"/>
      </svg>
      <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </button>

    <button class="footer-btn" onclick="showAbout()" aria-label="–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏">
      <svg class="ico" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 18v-6M12 8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span>
    </button>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="modal" style="display:none;"></div>

<script>
/** ================================================================
 *              TIME TRACKER ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (all-in-one)
 * ================================================================ */

/** === CONSTANTS =============== */
const STORAGE_KEY  = "myworkdays22";
const SETTINGS_KEY = "myworkdays_settings";
const DEFAULT_TAG  = "–ù–ê–°–¢–†–û–ô–ö–ê –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø";
const APP_VERSION  = "1.1.0 (2025-09-09)"; // –æ–±–Ω–æ–≤–ª–µ–Ω–æ

/** === LOCALSTORAGE ‚Äî INIT =============== */
let days = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
let tagsLib = JSON.parse(localStorage.getItem("tagsLib22") || "[]");
if (!Array.isArray(tagsLib) || tagsLib.length === 0) {
  tagsLib = [DEFAULT_TAG];
} else if (!tagsLib.includes(DEFAULT_TAG)) {
  tagsLib.unshift(DEFAULT_TAG);
}
let appSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
if (typeof appSettings.copyProtect === "undefined") appSettings.copyProtect = false;
if (typeof appSettings.noZoom === "undefined") appSettings.noZoom = false;
if (typeof appSettings.theme === "undefined") appSettings.theme = "light";
if (typeof appSettings.autoTheme === "undefined") appSettings.autoTheme = true;

function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
}
function saveAll() {
  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –¥–Ω–∏ –ø–æ –¥–∞—Ç–µ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  days.sort((a,b)=> (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(days));
  localStorage.setItem("tagsLib22", JSON.stringify(tagsLib));
}

/** === UI-BEHAVIOR INIT ============ */
function updateCopyProtect() {
  if (appSettings.copyProtect) {
    document.body.addEventListener('copy', blockCopy, true);
    document.body.style.userSelect = "none";
  } else {
    document.body.removeEventListener('copy', blockCopy, true);
    document.body.style.userSelect = "";
  }
}
function blockCopy(e) { e.preventDefault(); }

function updateNoZoom() {
  let viewport = document.querySelector('meta[name="viewport"]');
  if (viewport) {
    if (appSettings.noZoom) {
      viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
    } else {
      viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
    }
  }
}
function updateTheme() {
  if (appSettings.autoTheme && window.matchMedia) {
    appSettings.theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  document.body.classList.toggle("dark-theme", appSettings.theme === "dark");
}
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=> {
    if(appSettings.autoTheme) updateTheme();
  });
}

/** === HELPERS ======================= */
function todayStr() { return (new Date()).toISOString().slice(0,10); }
function findDay(date) { return days.find(d => d.date === date); }
function getOrCreateDay(date) {
  let d = findDay(date);
  if (!d) { d = { date, start:'', end:'', tags:[] }; days.push(d); }
  return d;
}
function toHM(dt) { let [h,m]=dt.split(":").map(Number); return [h||0,m||0]; }
function fromHM(h,m){ return (h<10?'0':'')+h+":"+(m<10?'0':'')+m; }
function diffMinutes(tm1, tm2) {
  let [h1,m1]=toHM(tm1||"0:0"), [h2,m2]=toHM(tm2||"0:0");
  return (h2*60+m2)-(h1*60+m1);
}
function roundMinutes(totalMin, step=10, direction='round') {
  let q = totalMin / step, res;
  if(direction==='down') res = Math.floor(q);
  else if(direction==='up') res = Math.ceil(q);
  else res = Math.round(q);
  return res * step;
}

/** === INIT UI SETTINGS === */
updateCopyProtect();
updateNoZoom();
updateTheme();

/** =========================================================  
 *               –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù (—Å–µ–≥–æ–¥–Ω—è)
 * ========================================================= */
function renderApp() {
  const dt = todayStr();
  const day = findDay(dt);
  const rows = [];
  rows.push(`<h1>–ú–æ–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</h1>`);

  rows.push(`
    <div class="row">
      <div class="dual-btn">
        <button class="btn" onclick="markNow('${dt}','start')">
          ‚ûî ${day?.start || '--:--'}
          <div class="btn-sub">–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø</div>
        </button>
        <button class="btn" onclick="openManualTime('${dt}','start')">
          üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨ –í–†–ï–ú–Ø</div>
        </button>
      </div>
      <div class="dual-btn">
        <button class="btn" onclick="markNow('${dt}','end')">
          ‚è± ${day?.end || '--:--'}
          <div class="btn-sub">–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø</div>
        </button>
        <button class="btn" onclick="openManualTime('${dt}','end')">
          üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨ –í–†–ï–ú–Ø</div>
        </button>
      </div>
    </div>
  `);

  if(day?.start && day?.end) {
    let time = diffMinutes(day.start, day.end);
    rows.push(`<div class="center"><span class="badge">${Math.floor(time/60)}—á ${(time%60).toString().padStart(2,"0")}–º</span> –æ–±—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</div>`);
  }

  rows.push(`<hr><div><b>–î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b></div>`);
  let tagSums = {};
  if (day?.tags?.length) {
    rows.push('<ul class="tags-list">');
    day.tags.forEach((t, i) => {
      let st = t.start, en = t.end;
      let mins = (st && en) ? diffMinutes(st, en) : 0;
      if (!tagSums[t.tag]) tagSums[t.tag] = 0;
      tagSums[t.tag] += Math.max(0, mins);
      let hr = Math.floor(Math.max(0, mins)/60), mn = Math.max(0, mins)%60;
      rows.push(`
        <li>
          <b>${t.tag}</b> ${st || '--:--'}‚Ä¶${en || '--:--'}${mins>0 ? ` <span class="small">(${hr}—á ${mn}–º)</span>` : ''}
          <div class="row" style="margin:.3em 0;flex-wrap:wrap;">
            <div class="dual-btn">
              <button class="btn" onclick="markTagNow('${dt}',${i}, 'start')">‚ûî ${t.start || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>
              <button class="btn" onclick="manualTagTime('${dt}',${i}, 'start')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>
            </div>
            <div class="dual-btn">
              <button class="btn" onclick="markTagNow('${dt}',${i}, 'end')">‚è± ${t.end || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>
              <button class="btn" onclick="manualTagTime('${dt}',${i}, 'end')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>
            </div>
            <button class="edit" onclick="editTag('${dt}',${i})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥">‚úé</button>
            <button class="edit" onclick="delTag('${dt}',${i})" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥">‚úï</button>
          </div>
        </li>
      `);
    });
    rows.push(`
      <li>
        <button class="btn fullw" onclick="addTagPlus('${dt}')" style="display:flex;align-items:center;gap:7px;justify-content:center;margin-top:4px;">
          ‚ûï<span style="color:#888;font-size:.96em;">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</span>
        </button>
      </li>
    `);
    rows.push('</ul>');
    if (Object.keys(tagSums).length > 0) {
      rows.push(`<div class="small" style="margin:7px 0 0 2px;"><b>–ò—Ç–æ–≥–æ –ø–æ —Ç–µ–≥–∞–º –∑–∞ —Å–µ–≥–æ–¥–Ω—è:</b><br>`);
      for (const tag in tagSums) {
        let tot = tagSums[tag], hr = Math.floor(tot/60), mn = tot%60;
        rows.push(`${tag}: ${hr}—á ${mn}–º<br>`);
      }
      rows.push(`</div>`);
    }
  } else {
    rows.push(`<div class="small">–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</div>
      <button class="btn fullw" onclick="addTagPlus('${dt}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>`);
  }
  rows.push(`<hr>`);
  document.getElementById('app').innerHTML = rows.join('\n');
  closeModal();
}

/** === –ú–ê–†–ö–ï–†–´ –í–†–ï–ú–ï–ù–ò (–ª—é–±–æ–π –¥–µ–Ω—å) ==== */
function markNow(date, type) {
  let d = getOrCreateDay(date);
  let now = new Date();
  d[type] = fromHM(now.getHours(), now.getMinutes());
  saveAll(); renderApp();
}
function openManualTime(date, type) {
  let d = getOrCreateDay(date);
  let val = (d[type] && /^\d\d:\d\d$/.test(d[type]))
    ? d[type]
    : (() => { let now=new Date(); return fromHM(now.getHours(), now.getMinutes()); })();
  let label = type === "start" ? "–í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞" : "–í—Ä–µ–º—è —É—Ö–æ–¥–∞";
  let html = `
    <div class="modal-title"><b>${label} ‚Äî ${date}</b></div>
    <form id="manualTimeForm">
      <label>${label}:<br>
        <input type="time" id="manualTimeInput" value="${val}" required>
      </label>
      <div class="row" style="margin-top:16px;">
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-cancel fullw" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  `;
  showModal(html);
  document.getElementById('manualTimeForm').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('manualTimeInput');
    const t = input.value.trim();
    if (!t) {
      input.classList.add('input-error'); input.focus();
      setTimeout(() => input.classList.remove('input-error'), 1000);
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!');
      return;
    }
    d[type] = t;
    saveAll();
    renderApp();
  };
}

/** === –¢–ï–ì–ò (–ª—é–±–æ–π –¥–µ–Ω—å) ==== */
function addTagPlus(date) {
  let d = getOrCreateDay(date);
  d.tags.push({ tag: DEFAULT_TAG, start: "", end: "" });
  saveAll(); renderApp();
}
function editTag(date, idx) {
  showTagModal(date, idx);
}
function delTag(date, idx) {
  let d = getOrCreateDay(date);
  if(d.tags && d.tags[idx] !== undefined) {
    if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "+d.tags[idx].tag+"?")) {
      d.tags.splice(idx,1);
      saveAll(); renderApp();
    }
  }
}
function markTagNow(date, idx, type) {
  let d = getOrCreateDay(date); if (!d.tags[idx]) return;
  let now = new Date();
  d.tags[idx][type] = fromHM(now.getHours(), now.getMinutes());
  saveAll(); renderApp();
}
function manualTagTime(date, idx, type) {
  let d = getOrCreateDay(date);
  let t = (d && d.tags[idx] && d.tags[idx][type]) || "";
  let label = (type === "start" ? "–ù–∞—á–∞–ª–æ —Ç–µ–≥–∞" : "–ö–æ–Ω–µ—Ü —Ç–µ–≥–∞");
  let html = `
    <div class="modal-title"><b>${label} ‚Äî ${date}</b></div>
    <form id="manualTagTimeForm">
      <label>${label}:<br>
        <input type="time" id="manualTagTimeInput" value="${t}" required>
      </label>
      <div class="row" style="margin-top:16px;">
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-cancel fullw" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  `;
  showModal(html);
  document.getElementById('manualTagTimeForm').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('manualTagTimeInput');
    const val = input.value.trim();
    if (!val) {
      input.classList.add('input-error'); input.focus();
      setTimeout(() => input.classList.remove('input-error'), 1000);
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!');
      return;
    }
    d.tags[idx][type] = val; saveAll(); renderApp();
  };
}

// —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞)
function showTagModal(date, tagIdx=null) {
  let d = getOrCreateDay(date);
  let tagObj = tagIdx !== null && d.tags[tagIdx] ? { ...d.tags[tagIdx] } : {
    tag: DEFAULT_TAG, start: d.start || "09:00", end: d.end || "18:00"
  };
  let tagOptions = [DEFAULT_TAG, ...tagsLib.filter(t => t !== DEFAULT_TAG)]
    .map(t => `<option value="${t}"></option>`).join("");
  let html = `
    <div class="modal-title"><b>${tagIdx!==null?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ':'–ù–æ–≤—ã–π'} —Ç–µ–≥ ‚Äî ${date}</b></div>
    <form id="tagForm">
      <label>–¢–µ–≥:<br>
        <input type="text" list="tagsSug" value="${tagObj.tag || ''}" id="tg" required autocomplete="off">
        <datalist id="tagsSug">${tagOptions}</datalist>
      </label><br>
      <label>–ù–∞—á–∞–ª–æ:<br>
        <input type="time" id="st" value="${tagObj.start}" required>
      </label><br>
      <label>–ö–æ–Ω–µ—Ü:<br>
        <input type="time" id="en" value="${tagObj.end}" required>
      </label><br>
      <div class="row">
        <button class="btn fullw" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-cancel fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </form>
  `;
  showModal(html);
  document.getElementById('tagForm').onsubmit = function(e) {
    e.preventDefault();
    let tg = document.getElementById('tg').value.trim();
    let st = document.getElementById('st').value, en = document.getElementById('en').value;
    if (!tg) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥");
    if (!tagsLib.includes(tg)) tagsLib.push(tg);
    if (tagIdx !== null) d.tags[tagIdx] = { tag: tg, start: st, end: en };
    else d.tags.push({ tag: tg, start: st, end: en });
    saveAll(); renderApp();
  };
}

/** === –ö–ê–õ–ï–ù–î–ê–†–¨ (–ü–ù-–í–°, –≤—ã—Ö–æ–¥–Ω—ã–µ –∫—Ä–∞—Å–Ω—ã–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ) === */
function showCalendar(mon=null, yr=null) {
  const now = new Date();
  const year = yr ?? now.getFullYear();
  const month = mon ?? now.getMonth(); // 0..11

  const first = new Date(year,month,1);
  const last  = new Date(year,month+1,0);
  const daysNum = last.getDate();

  // JS: 0=–í—Å..6=–°–±; –Ω—É–∂–Ω–æ —Å–º–µ—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–ª–∞—Å—å —Å –ü–ù
  const mondayIdx = (first.getDay() + 6) % 7; // 0 –¥–ª—è –ü–ù, 6 –¥–ª—è –í–°

  let content = `<div class="modal-title center"><b>${["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"][month]} ${year}</b></div>`;

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
  const wd = ["–ü–ù","–í–¢","–°–†","–ß–¢","–ü–¢","–°–ë","–í–°"];
  content += `<div class="calendar">`;
  content += `<div class="cal-head">` + wd.map((n,i)=>`<div ${i>=5?'style="color:#c23;"':''}>${n}</div>`).join('') + `</div>`;

  // –°–µ—Ç–∫–∞ –¥–Ω–µ–π
  content += `<div class="cal-grid">`;
  // –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
  for (let i=0; i<mondayIdx; i++) content += `<div class="cal-empty"></div>`;

  for (let day=1; day<=daysNum; day++) {
    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const d  = new Date(year, month, day);
    const dayOfWeek = (d.getDay()+6)%7; // 0..6, –≥–¥–µ 0=–ü–ù
    const isWeekend = (dayOfWeek>=5);
    const hasData = days.some(x=>x.date===ds);
    content += `
      <button class="cal-btn ${hasData?'selected':''} ${isWeekend?'is-weekend':''}" onclick="showDayEditor('${ds}')">
        <span class="daynum">${day}</span>
        ${hasData?'<span class="dot" aria-hidden="true"></span>':''}
      </button>
    `;
  }
  content += `</div></div>`;

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ—Å—è—Ü–∞–º–∏ + –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
  const prevM = month-1<0?11:month-1, prevY = month-1<0?year-1:year;
  const nextM = month+1>11?0:month+1, nextY = month+1>11?year+1:year;
  content += `
    <div class='row' style="margin-top:12px;">
      <button class="btn fullw btn-secondary" onclick="showCalendar(${prevM},${prevY})">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
      <button class="btn fullw" onclick="showCalendar(${nextM},${nextY})">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
    </div>
    <div class='row'>
      <button class="btn fullw" onclick="showDayEditor('${todayStr()}')">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="btn fullw btn-cancel" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(content);
}

// –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (–ø—Ä–æ—à–ª–æ–≥–æ/–±—É–¥—É—â–µ–≥–æ)
function showDayEditor(ds) {
  const d = getOrCreateDay(ds);
  // —Å—É–º–º–∏—Ä—É–µ–º –ø–æ —Ç–µ–≥–∞–º
  const tagSums = {};
  d.tags.forEach(t=>{
    if(t.start && t.end) {
      const mins = Math.max(0, diffMinutes(t.start, t.end));
      tagSums[t.tag] = (tagSums[t.tag]||0)+mins;
    }
  });
  let sumsHtml = '';
  if (Object.keys(tagSums).length) {
    sumsHtml = `<div class="small" style="margin-top:6px;"><b>–ò—Ç–æ–≥–æ –ø–æ —Ç–µ–≥–∞–º:</b><br>`+
      Object.entries(tagSums).map(([tg,min])=>{
        const hr=Math.floor(min/60), mn=min%60;
        return `${tg}: ${hr}—á ${mn}–º`;
      }).join('<br>') + `</div>`;
  }

  let tagsListHtml = '';
  if (d.tags.length) {
    tagsListHtml = '<ul class="tags-list">'+ d.tags.map((t,i)=>{
      const mins = (t.start && t.end) ? Math.max(0, diffMinutes(t.start,t.end)) : 0;
      const mtxt = mins>0?` <span class="small">(${Math.floor(mins/60)}—á ${mins%60}–º)</span>`:'';
      return `
        <li>
          <b>${t.tag}</b> ${t.start||'--:--'}‚Ä¶${t.end||'--:--'}${mtxt}
          <div class="row" style="margin:.3em 0;flex-wrap:wrap;">
            <div class="dual-btn">
              <button class="btn" onclick="markTagNow('${ds}',${i}, 'start')">‚ûî ${t.start || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>
              <button class="btn" onclick="manualTagTime('${ds}',${i}, 'start')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>
            </div>
            <div class="dual-btn">
              <button class="btn" onclick="markTagNow('${ds}',${i}, 'end')">‚è± ${t.end || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>
              <button class="btn" onclick="manualTagTime('${ds}',${i}, 'end')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>
            </div>
            <button class="edit" onclick="showTagModal('${ds}',${i})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥">‚úé</button>
            <button class="edit" onclick="delTag('${ds}',${i})" title="–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥">‚úï</button>
          </div>
        </li>
      `;
    }).join('') + '</ul>';
  } else {
    tagsListHtml = `<div class="small">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>`;
  }

  const html = `
    <div class="modal-title"><b>–î–µ–Ω—å: ${ds}</b></div>
    <div>–†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è:</div>
    <div class="row">
      <div class="dual-btn">
        <button class="btn" onclick="markNow('${ds}','start')">‚ûî ${d.start || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>
        <button class="btn" onclick="openManualTime('${ds}','start')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>
      </div>
      <div class="dual-btn">
        <button class="btn" onclick="markNow('${ds}','end')">‚è± ${d.end || '--:--'}<div class="btn-sub">–¢–ï–ö–£–©–ï–ï</div></button>
        <button class="btn" onclick="openManualTime('${ds}','end')">üïí<div class="btn-sub">–í–´–ë–†–ê–¢–¨</div></button>
      </div>
    </div>
    ${ (d.start && d.end) ? `<div class="small" style="margin:.2em 0 .8em;">
      –ò—Ç–æ–≥–æ: <b>${Math.floor(diffMinutes(d.start,d.end)/60)}—á ${String(diffMinutes(d.start,d.end)%60).padStart(2,'0')}–º</b>
    </div>` : '' }

    <hr>
    <div><b>–¢–µ–≥–∏:</b></div>
    ${tagsListHtml}
    <div class="row">
      <button class="btn fullw" onclick="addTagPlus('${ds}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
    </div>
    ${sumsHtml}
    <hr>
    <div class="row">
      <button class="btn fullw btn-secondary" onclick="showCalendar(${new Date(ds).getMonth()},${new Date(ds).getFullYear()})">‚Üê –ö –∫–∞–ª–µ–Ω–¥–∞—Ä—é</button>
      <button class="btn fullw btn-cancel" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(html);
}

/** === –≠–ö–°–ü–û–†–¢ === */
function showExport() {
  let minDate = days.length ? days[0].date : todayStr();
  let maxDate = days.length ? days[days.length-1].date : todayStr();
  let html = `
    <div class="modal-title"><b>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</b></div>
    <form id="reportForm">
      <div class="setting-row">–ü–µ—Ä–∏–æ–¥:
        <select id="per">
          <option value="1-15">1‚Äì15</option>
          <option value="16-31">16‚Äì31</option>
          <option value="full">–í–µ—Å—å –º–µ—Å—è—Ü</option>
          <option value="range">–ü–µ—Ä–∏–æ–¥</option>
        </select>
        <input type="date" id="dfrom" style="display:none" value="${minDate}"> ‚Äî
        <input type="date" id="dto" style="display:none" value="${maxDate}">
      </div>
      <div class="setting-row">–≠–∫—Å–ø–æ—Ä—Ç:
        <select id="expType">
          <option value="all">–í—Å—ë</option>
          <option value="tags">–¢–æ–ª—å–∫–æ —Ç–µ–≥–∏</option>
          <option value="work">–¢–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã (–ø—Ä–∏—Ö–æ–¥/—É—Ö–æ–¥)</option>
        </select>
      </div>
      <div class="setting-row">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ:
        <select id="roundM">
          <option value="60">–î–æ 1 —á–∞—Å–∞</option>
          <option value="30">–î–æ 30 –º–∏–Ω</option>
          <option value="10" selected>–î–æ 10 –º–∏–Ω</option>
        </select>
        <select id="roundDir">
          <option value="round">–û–±—ã—á–Ω–æ</option>
          <option value="up">–í–≤–µ—Ä—Ö</option>
          <option value="down">–í–Ω–∏–∑</option>
        </select>
      </div>
      <div class="setting-row">–¢–µ–≥–∏: <select multiple id="tagsFlt" style="min-width:70px;min-height:2em;">
        ${tagsLib.map(t=>`<option value="${t}" selected>${t}</option>`).join("")}
      </select> <span class="small">(–¥–ª—è —Ä–µ–∂–∏–º–∞ "—Ç–µ–≥–∏")</span></div>
      <div class="row">
        <button class="btn fullw" type="submit">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn btn-cancel fullw" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
    <div id="exportResult"></div>
  `;
  showModal(html);

  let perSel = document.getElementById("per");
  let fromD = document.getElementById("dfrom");
  let toD = document.getElementById("dto");
  perSel.onchange = function() {
    const show = perSel.value==='range';
    fromD.style.display = show?'inline':'none';
    toD.style.display   = show?'inline':'none';
  };

  document.getElementById("reportForm").onsubmit = function(e) {
    e.preventDefault();
    let period = perSel.value;
    let from = fromD.value || minDate;
    let to = toD.value || maxDate;
    let exp = document.getElementById("expType").value;
    let roundM = +document.getElementById("roundM").value;
    let roundDir = document.getElementById("roundDir").value;
    let tagsFlt = Array.from(document.getElementById("tagsFlt").selectedOptions).map(op=>op.value);

    function inSelectedMonth(dt) {
      let selm = days.length ? days[days.length-1].date.slice(5,7) : todayStr().slice(5,7);
      return dt.slice(5,7) === selm;
    }
    let list;
    if (period === "1-15") {
      list = days.filter(d=>+d.date.slice(8,10)<=15 && inSelectedMonth(d.date));
    } else if(period === "16-31") {
      list = days.filter(d=>+d.date.slice(8,10)>=16 && inSelectedMonth(d.date));
    } else if(period === "range") {
      list = days.filter(d=>d.date >= from && d.date <= to);
    } else { // full
      list = days.filter(d=>inSelectedMonth(d.date));
    }

    let rows = [];
    let tagTotals = {};

    if (exp === 'work' || exp === 'all') {
      for (const d of list) {
        if (!d.start || !d.end) continue;
        let mins = diffMinutes(d.start, d.end);
        let rounded = roundMinutes(mins, roundM, roundDir);
        let hr = Math.floor(rounded / 60), mn = rounded % 60;
        rows.push(`${d.date}: ${d.start} ‚Äì ${d.end} (${hr}—á ${mn}–º)`);
      }
    }

    if (exp === 'tags' || exp === 'all') {
      for (const d of list) {
        if (!d.tags?.length) continue;
        for (const tag of d.tags) {
          if (tagsFlt.includes(tag.tag)) {
            let mins = diffMinutes(tag.start||"00:00", tag.end||"00:00");
            if (!tagTotals[tag.tag]) tagTotals[tag.tag] = 0;
            tagTotals[tag.tag] += Math.max(0, mins);
            let rounded = roundMinutes(Math.max(0, mins), roundM, roundDir);
            let hr = Math.floor(rounded / 60), mn = rounded % 60;
            rows.push(`${d.date}: ${tag.tag} ‚Äî ${tag.start||'--:--'}-${tag.end||'--:--'} (${hr}—á ${mn}–º)`);
          }
        }
      }
      if (Object.keys(tagTotals).length) {
        rows.push('\n–°—É–º–º–∞—Ä–Ω–æ –ø–æ —Ç–µ–≥–∞–º:');
        for (const tag of Object.keys(tagTotals)) {
          let tot = tagTotals[tag];
          let rounded = roundMinutes(tot, roundM, roundDir);
          let hr = Math.floor(rounded / 60), mn = rounded % 60;
          rows.push(`${tag}: ${hr}—á ${mn}–º`);
        }
      }
    }

    let resTxt = rows.join('\n');
    document.getElementById("exportResult").innerHTML =
      `<div class="export"><b>–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç:</b><br>
      <textarea>${resTxt}</textarea>
      <br>
      <button class="btn" type="button" onclick="downloadText()">–°–∫–∞—á–∞—Ç—å .txt</button>
      <button class="btn" type="button" onclick="copyExportText()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn" type="button" onclick="shareToTelegram()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
      </div>`;
    window.export__text = resTxt;
    return false;
  };
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
function shareToTelegram() {
  if (!window.export__text) return;
  let text = window.export__text;
  if (text.length > 4000) text = text.slice(0, 4000) + '...';
  let url = "https://t.me/share/url?url=&text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}
// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
function copyExportText() {
  if (!window.export__text) return;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(window.export__text)
      .then(() => { alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"); })
      .catch(() => { fallbackCopy(); });
  } else { fallbackCopy(); }
  function fallbackCopy() {
    try {
      let ta = document.createElement("textarea");
      ta.value = window.export__text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
    } catch {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
    }
  }
}
// –°–∫–∞—á–∞—Ç—å TXT
function downloadText() {
  let b = new Blob([window.export__text || ""], { type:"text/plain" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(b);
  link.download = "work_report.txt";
  link.click();
}

/** === –ù–ê–°–¢–†–û–ô–ö–ò === */
function showSettings() {
  let html = `
    <div class="modal-title"><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b></div>
    <ul class="tags-list">
      <li>
        <label>
          <input type="checkbox" id="setCopyProtect" ${appSettings.copyProtect ? "checked" : ""}>
          üõ°Ô∏è –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        </label>
      </li>
      <li>
        <label>
          <input type="checkbox" id="setNoZoom" ${appSettings.noZoom ? "checked" : ""}>
          üîí –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        </label>
      </li>
      <li>
        <label>
          <input type="checkbox" id="setAutoTheme" ${appSettings.autoTheme ? "checked" : ""}>
          üåì –ü–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–º—É —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        </label>
      </li>
      <li>
        <label>
          üé® –¢–µ–º–Ω–∞—è —Ç–µ–º–∞:
          <select id="setTheme" ${appSettings.autoTheme ? "disabled" : ""}>
            <option value="light" ${appSettings.theme === "light" ? "selected" : ""}>–°–≤–µ—Ç–ª–∞—è</option>
            <option value="dark" ${appSettings.theme === "dark" ? "selected" : ""}>–¢—ë–º–Ω–∞—è</option>
          </select>
        </label>
      </li>
      <li><hr></li>
      <li><b>–ú–æ–∏ —Ç–µ–≥–∏:</b></li>
      ${tagsLib.map((t, i) => `
        <li style="margin-bottom:6px;">
          <span class="badge">${t}</span>
          ${i === 0
            ? '<span class="small">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)</span>'
            : `<button class="edit" onclick="removeTagLib(${i})">‚úï —É–¥–∞–ª–∏—Ç—å</button>`}
        </li>
      `).join("")}
      <li>
        <input type="text" id="newTgInp" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥...">
        <button class="btn" onclick="addTagFromSettings()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </li>
      <li>
        <button class="btn btn-cancel" onclick="resetAllData()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <span class="small">(–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ)</span>
      </li>
    </ul>
    <div class="row">
      <button class="btn fullw" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(html);

  document.getElementById('setCopyProtect').onchange = function() {
    appSettings.copyProtect = this.checked; saveSettings(); updateCopyProtect();
  };
  document.getElementById('setNoZoom').onchange = function() {
    appSettings.noZoom = this.checked; saveSettings(); updateNoZoom();
  };
  document.getElementById('setAutoTheme').onchange = function() {
    appSettings.autoTheme = this.checked; saveSettings();
    document.getElementById('setTheme').disabled = appSettings.autoTheme;
    updateTheme();
  };
  document.getElementById('setTheme').onchange = function() {
    appSettings.theme = this.value; saveSettings(); updateTheme();
  };
}
function addTagFromSettings() {
  let inp = document.getElementById('newTgInp');
  let newTag = inp.value.trim();
  if(!newTag) return;
  if(!tagsLib.includes(newTag)) {
    tagsLib.push(newTag); saveAll(); closeModal(); renderApp();
  }
}
function removeTagLib(i) {
  if (i === 0) return;
  if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${tagsLib[i]}"? –í—Å–µ –∑–∞–ø–∏—Å–∏ —Å —ç—Ç–∏–º —Ç–µ–≥–æ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è, –Ω–æ –Ω–æ–≤—ã–π –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.`)) {
    tagsLib.splice(i, 1); saveAll(); showSettings(); renderApp();
  }
}
function resetAllData() {
  if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
    days = []; tagsLib = [DEFAULT_TAG];
    saveAll(); closeModal(); renderApp();
  }
}

/** === ABOUT === */
function showAbout() {
  let html = `
    <div class="modal-title"><b>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</b></div>
    <div class="small" style="line-height:1.7;">
      <b>–ê–≤—Ç–æ—Ä –∏–¥–µ–∏:</b> –ê–Ω—Ç–æ–Ω –ú–∞–≥–æ–º–µ–¥–æ–≤<br>
      <b>Telegram / Instagram:</b> <a href="https://t.me/xcve33" target="_blank" rel="noreferrer">@xcve33</a><br>
      <b>Email:</b> <a href="mailto:akitsatnafiya@gmail.com">akitsatnafiya@gmail.com</a><br>
      <b>GitHub:</b> <a href="https://github.com/sunpole" target="_blank" rel="noreferrer">sunpole</a><br><br>
      <b>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞:</b><br>
      –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ (—á–∞—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞), –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ—Ä–∏–∏ –ø—Ä–æ–º—Ç–æ–≤ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∞–≤—Ç–æ—Ä–∞.<br>
      –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Ä–∞–¥–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —Å AI.<br><br>
      <b>–í–µ—Ä—Å–∏—è:</b> ${APP_VERSION}<br>
      <b>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</b> –¢—Ä–µ–∫–µ—Ä —É—á—ë—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏—Ö–æ–¥–∞, —É—Ö–æ–¥–∞ –∏ –≤–∏–¥–æ–≤ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ —Ç–µ–≥–∞–º.<br><br>
      <b>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</b><br>
      ‚Äî –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (LocalStorage)<br>
      ‚Äî –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞<br>
      ‚Äî –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç<br><br>
      <button class="btn btn-cancel" style="font-size:0.98em;white-space:normal;line-height:1.1;padding:0.7em 1em;" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  `;
  showModal(html);
}

/** === –ú–û–î–ê–õ–¨–ù–û–ï –Ø–î–†–û === */
function showModal(html) {
  let m = document.getElementById("modal");
  m.innerHTML = `<div class="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">${html}</div>
  </div>`;
  m.style.display = '';
}
function closeModal(e) {
  if(e && e.target!==document.getElementById("modal"))return;
  document.getElementById("modal").style.display='none';
}

/** === –°—Ç–∞—Ä—Ç === */
renderApp();
</script>
</body>
</html>
